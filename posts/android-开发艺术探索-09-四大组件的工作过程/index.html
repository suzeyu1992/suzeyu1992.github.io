<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>《Android 开发艺术探索》 09-四大组件的工作过程 - Blog</title><meta name="Description" content=""><meta property="og:title" content="《Android 开发艺术探索》 09-四大组件的工作过程" />
<meta property="og:description" content="第九章: 还原四大组件的本质 blog相关代码 四大组件的运行状态 四大组件中除了BroadcastReceiver以外, 其余的三种组件都必须在An" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://suzeyu.com/posts/android-%E5%BC%80%E5%8F%91%E8%89%BA%E6%9C%AF%E6%8E%A2%E7%B4%A2-09-%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%9A%84%E5%B7%A5%E4%BD%9C%E8%BF%87%E7%A8%8B/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2016-08-16T09:46:53+00:00" />
<meta property="article:modified_time" content="2016-08-16T09:46:53+00:00" /><meta property="og:site_name" content="szySky Blog" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="《Android 开发艺术探索》 09-四大组件的工作过程"/>
<meta name="twitter:description" content="第九章: 还原四大组件的本质 blog相关代码 四大组件的运行状态 四大组件中除了BroadcastReceiver以外, 其余的三种组件都必须在An"/>
<meta name="application-name" content="Blog">
<meta name="apple-mobile-web-app-title" content="Blog"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://suzeyu.com/posts/android-%E5%BC%80%E5%8F%91%E8%89%BA%E6%9C%AF%E6%8E%A2%E7%B4%A2-09-%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%9A%84%E5%B7%A5%E4%BD%9C%E8%BF%87%E7%A8%8B/" /><link rel="prev" href="http://suzeyu.com/posts/android-%E5%BC%80%E5%8F%91%E8%89%BA%E6%9C%AF%E6%8E%A2%E7%B4%A2-08-%E7%90%86%E8%A7%A3window%E5%92%8Cwindowmanager/" /><link rel="next" href="http://suzeyu.com/posts/android-%E5%BC%80%E5%8F%91%E8%89%BA%E6%9C%AF%E6%8E%A2%E7%B4%A2-10-android%E7%9A%84%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "《Android 开发艺术探索》 09-四大组件的工作过程",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/suzeyu.com\/posts\/android-%E5%BC%80%E5%8F%91%E8%89%BA%E6%9C%AF%E6%8E%A2%E7%B4%A2-09-%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%9A%84%E5%B7%A5%E4%BD%9C%E8%BF%87%E7%A8%8B\/"
        },"genre": "posts","keywords": "android, 笔记","wordcount":  19419 ,
        "url": "http:\/\/suzeyu.com\/posts\/android-%E5%BC%80%E5%8F%91%E8%89%BA%E6%9C%AF%E6%8E%A2%E7%B4%A2-09-%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%9A%84%E5%B7%A5%E4%BD%9C%E8%BF%87%E7%A8%8B\/","datePublished": "2016-08-16T09:46:53+00:00","dateModified": "2016-08-16T09:46:53+00:00","publisher": {
            "@type": "Organization",
            "name": "9999999","logo": "https:\/\/avatars.githubusercontent.com\/u\/13827428?s=96\u0026v=4"},"author": {
                "@type": "Person",
                "name": "su"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : '' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Blog">Szy&#39;sky Blog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 所有文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="猪猪猪" id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Blog">Szy&#39;sky Blog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="猪猪猪" id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">所有文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">《Android 开发艺术探索》 09-四大组件的工作过程</h1><h2 class="single-subtitle">抄书系列</h2><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>su</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2016-08-16">2016-08-16</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 19419 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 39 分钟&nbsp;<span id="/posts/android-%E5%BC%80%E5%8F%91%E8%89%BA%E6%9C%AF%E6%8E%A2%E7%B4%A2-09-%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%9A%84%E5%B7%A5%E4%BD%9C%E8%BF%87%E7%A8%8B/" class="leancloud_visitors" data-flag-title="《Android 开发艺术探索》 09-四大组件的工作过程">
                        <i class="far fa-eye fa-fw"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;次阅读
                    </span>&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#四大组件的运行状态">四大组件的运行状态</a></li>
    <li><a href="#activity的工作过程">Activity的工作过程</a></li>
    <li><a href="#service的工作流程">Service的工作流程</a>
      <ul>
        <li><a href="#service的启动过程">Service的启动过程</a></li>
        <li><a href="#service的绑定过程">Service的绑定过程</a></li>
      </ul>
    </li>
    <li><a href="#broadcastreceiver的工作流程">BroadcastReceiver的工作流程</a>
      <ul>
        <li><a href="#广播的注册过程">广播的注册过程</a></li>
        <li><a href="#广播的发送和接收过程">广播的发送和接收过程</a></li>
      </ul>
    </li>
    <li><a href="#contentprovider的工作机制">ContentProvider的工作机制</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><blockquote>
<p>第九章: 还原四大组件的本质</p>
</blockquote>
<p><a href="https://github.com/suzeyu1992/Notes_AndroidDevSeek" target="_blank" rel="noopener noreffer">blog相关代码</a></p>
<h2 id="四大组件的运行状态">四大组件的运行状态</h2>
<p>四大组件中除了<code>BroadcastReceiver</code>以外, 其余的三种组件都必须在<strong>AndroidManifest</strong>中注册, 对于<code>BroadcastReceiver</code>来说, 既可以在清单文件中注册, 也可以通过代码来注册. 在调用形式上除了<code>ContentProvider</code>不需要借助<code>Intent</code>. 其余的三大组件都需要Intent</p>
<p><strong>Activity</strong>是一种展示型组件, 用于向用户直接地展示一个界面, 并且可以接收用户的输入信息从而进行交互. <code>Activity</code>是最重要的一种组件, 对于用户来说它就是应用的全部, 因为其他三大组件对用户来说是无法感知的. <code>Activity</code>的启动由<code>Intent</code>触发, 其中<code>Intent</code>可以分为<strong>显式和隐式</strong>. <strong>显式Intent</strong>可以明确的指向一个<code>Activity</code>, 而<strong>隐式Intent</strong>则指向一个或者多个Activity组件. 或者是没有<code>Activity</code>组件可以处理这个隐式的Intent. 一个<code>Activity</code>具有特定的启动模式. 也可以通过<code>finish</code>来停止. 总结来说, <code>Activity</code>组件的主要作用是展示一个界面并和用户交互, 它扮演的是一种前台界面的角色.</p>
<hr>
<p><strong>Service</strong>是一种计算型组件, 用于后台执行一系列计算任务. 运行在后台,用户是无法感知的. <code>Service</code>和<code>Activity</code>的不同: <code>Activity</code>组件只有一种运行模式,即<code>Activity</code>处于启动状态, 但是<code>Service</code>组件有两种状态: <strong>启动状态</strong>和<strong>绑定状态</strong>.</p>
<ul>
<li>当<code>Service</code>处于启动状态时, 这个时候Service内部可以做一些后台计算. 尽管<code>Service</code>组件是用于执行后台计算的, 但是它本身是运行在主线程的. 因此单独的耗时操作仍然需要单独的线程去执行.</li>
<li>当<code>Service</code>处于绑定状态时, 内部同样可以进行后台计算, 但是处于这种状态时, 外界可以很方便的和<code>Service</code>组件进行通信.</li>
</ul>
<p><code>Service</code>可以停止, 需要灵活采用<code>stopService</code>和<code>unBindService</code></p>
<hr>
<p><strong>BroadcastReceiver</strong>是一种消息型组件, 用于在不同的组件乃至不同的应用之间传递消息. 同样无法被用户感知, 因为是运行在系统内部, 广播的注册方式有两种:<strong>静态注册</strong>和<strong>动态注册</strong></p>
<ul>
<li><strong>静态注册</strong>: 在清单文件中进行注册广播, 这种广播在应用安装时会被系统解析, 此种形式的广播不需要应用启动就可以接收到相应的广播.</li>
<li><strong>动态注册</strong>: 需要通过<code>Context.registerReceiver()</code>来实现, 并在不需要的时候通过<code>Context.unRegisterReceiver()</code>来解除广播. 此种形态的广播要应用启动才能注册和接收广播. 在实际开发中通过<code>Context</code>的一系列的<code>send</code>方法来发送广播, 被发送的广播会被系统发送给感兴趣的广播接收者, 发送和接收的过程的匹配是通过广播接收者的<code>&lt;intent-filter&gt;</code>来描述的.</li>
</ul>
<p>可以实现低耦合的观察者模式, 观察者和被观察者之间可以没有任何耦合. 但广播不适合来做耗时操作.</p>
<hr>
<p><strong>ContentProvider</strong>是一种数据共享组件, 用于向其他组件乃至其他应用共享数据. 无法被用户感知. 对于内容提供者来说, 它只需要实现增删改查四种基本操作, 在它内部维持着一份数据集合, 这个数据集合既可以通过数据库来实现, 也可以采用其他任何类型来实现, 例如list或者map.  <code>ContentProvider</code>对数据集合的具体实现并没有任何要求.</p>
<p>要注意处理好内部的<code>insert</code>, <code>delete</code>, <code>update</code>, <code>query</code>方法的线程同步, 因为这几个方法是在<code>Binder</code>线程池被调用.</p>
<h2 id="activity的工作过程">Activity的工作过程</h2>
<p>虽然要打开一个<code>Activity</code>很简单, 但是不应该只是局限于表面. 了解其内部走向构成.所以一切从<code>startActivity(intent)</code>这个方法开始.</p>
<p><code>startActivity()</code>有好几种重载方式但是最终都是调用<code>startActivityForResult()</code>方法.</p>
<p><strong>注意这里分析的是5.0版本的源码,  和6.0源码实现稍微不同</strong></p>
<p>首先看<code>startActivityForResult()</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">startActivityForResult</span><span class="o">(</span><span class="n">Intent</span> <span class="n">intent</span><span class="o">,</span> <span class="kt">int</span> <span class="n">requestCode</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="n">Bundle</span> <span class="n">options</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">mParent</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
       <span class="n">Instrumentation</span><span class="o">.</span><span class="na">ActivityResult</span> <span class="n">ar</span> <span class="o">=</span>
           <span class="n">mInstrumentation</span><span class="o">.</span><span class="na">execStartActivity</span><span class="o">(</span>
               <span class="k">this</span><span class="o">,</span> <span class="n">mMainThread</span><span class="o">.</span><span class="na">getApplicationThread</span><span class="o">(),</span> <span class="n">mToken</span><span class="o">,</span> <span class="k">this</span><span class="o">,</span>
               <span class="n">intent</span><span class="o">,</span> <span class="n">requestCode</span><span class="o">,</span> <span class="n">options</span><span class="o">);</span>
       <span class="k">if</span> <span class="o">(</span><span class="n">ar</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
           <span class="n">mMainThread</span><span class="o">.</span><span class="na">sendActivityResult</span><span class="o">(</span>
               <span class="n">mToken</span><span class="o">,</span> <span class="n">mEmbeddedID</span><span class="o">,</span> <span class="n">requestCode</span><span class="o">,</span> <span class="n">ar</span><span class="o">.</span><span class="na">getResultCode</span><span class="o">(),</span>
               <span class="n">ar</span><span class="o">.</span><span class="na">getResultData</span><span class="o">());</span>
       <span class="o">}</span>
       <span class="k">if</span> <span class="o">(</span><span class="n">requestCode</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
           <span class="n">mStartedActivity</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
       <span class="o">}</span>

       <span class="kd">final</span> <span class="n">View</span> <span class="n">decor</span> <span class="o">=</span> <span class="n">mWindow</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">mWindow</span><span class="o">.</span><span class="na">peekDecorView</span><span class="o">()</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
       <span class="k">if</span> <span class="o">(</span><span class="n">decor</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
           <span class="n">decor</span><span class="o">.</span><span class="na">cancelPendingInputEvents</span><span class="o">();</span>
       <span class="o">}</span>
       <span class="c1">// TODO Consider clearing/flushing other event sources and events for child windows.
</span><span class="c1"></span>   <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
       <span class="k">if</span> <span class="o">(</span><span class="n">options</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
           <span class="n">mParent</span><span class="o">.</span><span class="na">startActivityFromChild</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">intent</span><span class="o">,</span> <span class="n">requestCode</span><span class="o">,</span> <span class="n">options</span><span class="o">);</span>
       <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
           <span class="c1">// Note we want to go through this method for compatibility with
</span><span class="c1"></span>           <span class="c1">// existing applications that may have overridden it.
</span><span class="c1"></span>           <span class="n">mParent</span><span class="o">.</span><span class="na">startActivityFromChild</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">intent</span><span class="o">,</span> <span class="n">requestCode</span><span class="o">);</span>
       <span class="o">}</span>
   <span class="o">}</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">options</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isTopOfTask</span><span class="o">())</span> <span class="o">{</span>
       <span class="n">mActivityTransitionState</span><span class="o">.</span><span class="na">startExitOutTransition</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">options</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>关注<code>mParent==null</code>的分支. <code>mParent</code>代表的是<code>ViewGroup</code>, <code>ActivityGroup</code>最开始被用来在一个界面中嵌入多个子<code>Activity</code>, 在<strong>API13</strong>已经被废弃. 系统推荐使用<code>Fragment</code>代替<code>ActivityGroup</code>. 注意<code>mMainThread.getApplicationThread()</code>这个参数, 它的参数类型是<code>ApplicationThread</code>, <code>ApplicationThread</code>是<code>ActivityThread</code>的一个内部类.</p>
<p><strong>看一下<code>Instrumentation#execStartActivity()</code>这个方法</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">ActivityResult</span> <span class="nf">execStartActivity</span><span class="o">(</span>
       <span class="n">Context</span> <span class="n">who</span><span class="o">,</span> <span class="n">IBinder</span> <span class="n">contextThread</span><span class="o">,</span> <span class="n">IBinder</span> <span class="n">token</span><span class="o">,</span> <span class="n">Activity</span> <span class="n">target</span><span class="o">,</span>
       <span class="n">Intent</span> <span class="n">intent</span><span class="o">,</span> <span class="kt">int</span> <span class="n">requestCode</span><span class="o">,</span> <span class="n">Bundle</span> <span class="n">options</span><span class="o">)</span> <span class="o">{</span>
       
   <span class="n">IApplicationThread</span> <span class="n">whoThread</span> <span class="o">=</span> <span class="o">(</span><span class="n">IApplicationThread</span><span class="o">)</span> <span class="n">contextThread</span><span class="o">;</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">mActivityMonitors</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
       <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mSync</span><span class="o">)</span> <span class="o">{</span>
           <span class="kd">final</span> <span class="kt">int</span> <span class="n">N</span> <span class="o">=</span> <span class="n">mActivityMonitors</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
           <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="n">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
               <span class="kd">final</span> <span class="n">ActivityMonitor</span> <span class="n">am</span> <span class="o">=</span> <span class="n">mActivityMonitors</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
               <span class="k">if</span> <span class="o">(</span><span class="n">am</span><span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">who</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">intent</span><span class="o">))</span> <span class="o">{</span>
                   <span class="n">am</span><span class="o">.</span><span class="na">mHits</span><span class="o">++;</span>
                   <span class="k">if</span> <span class="o">(</span><span class="n">am</span><span class="o">.</span><span class="na">isBlocking</span><span class="o">())</span> <span class="o">{</span>
                       <span class="k">return</span> <span class="n">requestCode</span> <span class="o">&gt;=</span> <span class="n">0</span> <span class="o">?</span> <span class="n">am</span><span class="o">.</span><span class="na">getResult</span><span class="o">()</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
                   <span class="o">}</span>
                   <span class="k">break</span><span class="o">;</span>
               <span class="o">}</span>
           <span class="o">}</span>
       <span class="o">}</span>
   <span class="o">}</span>
   <span class="k">try</span> <span class="o">{</span>
       <span class="n">intent</span><span class="o">.</span><span class="na">migrateExtraStreamToClipData</span><span class="o">();</span>
       <span class="n">intent</span><span class="o">.</span><span class="na">prepareToLeaveProcess</span><span class="o">();</span>
       <span class="c1">// 启动Activity的真正实现
</span><span class="c1"></span>       <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">ActivityManagerNative</span><span class="o">.</span><span class="na">getDefault</span><span class="o">()</span>
           <span class="o">.</span><span class="na">startActivity</span><span class="o">(</span><span class="n">whoThread</span><span class="o">,</span> <span class="n">who</span><span class="o">.</span><span class="na">getBasePackageName</span><span class="o">(),</span> <span class="n">intent</span><span class="o">,</span>
                   <span class="n">intent</span><span class="o">.</span><span class="na">resolveTypeIfNeeded</span><span class="o">(</span><span class="n">who</span><span class="o">.</span><span class="na">getContentResolver</span><span class="o">()),</span>
                   <span class="n">token</span><span class="o">,</span> <span class="n">target</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">target</span><span class="o">.</span><span class="na">mEmbeddedID</span> <span class="o">:</span> <span class="kc">null</span><span class="o">,</span>
                   <span class="n">requestCode</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">options</span><span class="o">);</span>
       <span class="n">checkStartActivityResult</span><span class="o">(</span><span class="n">result</span><span class="o">,</span> <span class="n">intent</span><span class="o">);</span>
   <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
   <span class="o">}</span>
   <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><p>代码中真正启动<code>Activity</code>的真正实现是由<code>ActivityManagerNative.getDefault().startActivity()</code>方法完成的. 后面对<code>ActivityManagerService</code>简称<code>AMS</code>. <code>AMS</code>继承自<code>ActivityManagerNative()</code>, 而<code>ActivityManagerNative()</code>继承自<code>Binder</code>并实现了<code>IActivityManager</code>这个<code>Binder</code>接口, 因此<code>AMS</code>也是一个<code>Binder</code>, 它是<code>IActivityManager</code>的具体实现.</p>
<p>由于<code>ActivityManagerNative.getDefault()</code>本质是一个<code>IActivityManager</code>类型的<code>Binder</code>对象, 因此具体实现是<code>AMS</code>.  在<code>ActivityManagerNative</code>中, <code>AMS</code>这个Binder对象采用单例模式对外提供, <code>Singleton</code>是一个单例封装类. 第一次调用它的<code>get()</code>方法时会通过create方法来初始化<code>AMS</code>这个<code>Binder</code>对象, 在后续调用中会返回这个对象.  具体实现如下代码.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">static</span> <span class="kd">public</span> <span class="n">IActivityManager</span> <span class="nf">getDefault</span><span class="o">()</span> <span class="o">{</span>
   <span class="k">return</span> <span class="n">gDefault</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">IActivityManager</span><span class="o">&gt;</span> <span class="n">gDefault</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">IActivityManager</span><span class="o">&gt;()</span> <span class="o">{</span>
   <span class="kd">protected</span> <span class="n">IActivityManager</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
       <span class="n">IBinder</span> <span class="n">b</span> <span class="o">=</span> <span class="n">ServiceManager</span><span class="o">.</span><span class="na">getService</span><span class="o">(</span><span class="s">&#34;activity&#34;</span><span class="o">);</span>
       <span class="k">if</span> <span class="o">(</span><span class="kc">false</span><span class="o">)</span> <span class="o">{</span>
           <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">&#34;ActivityManager&#34;</span><span class="o">,</span> <span class="s">&#34;default service binder = &#34;</span> <span class="o">+</span> <span class="n">b</span><span class="o">);</span>
       <span class="o">}</span>
       <span class="n">IActivityManager</span> <span class="n">am</span> <span class="o">=</span> <span class="n">asInterface</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
       <span class="k">if</span> <span class="o">(</span><span class="kc">false</span><span class="o">)</span> <span class="o">{</span>
           <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">&#34;ActivityManager&#34;</span><span class="o">,</span> <span class="s">&#34;default service = &#34;</span> <span class="o">+</span> <span class="n">am</span><span class="o">);</span>
       <span class="o">}</span>
       <span class="k">return</span> <span class="n">am</span><span class="o">;</span>
   <span class="o">}</span>
<span class="o">};</span>
</code></pre></div><p>由上可以看到关于Activity的启动是由<code>ActivityManagerNative.getDefault()</code>来启动的, 而<code>ActivityManagerNative.getDefault()</code>实际上是<code>AMS</code>, 所以<code>Activity</code>的启动过程又被转移到了<code>AMS</code>中,  接下来查看<code>AMS</code>中的<code>startActivity()</code>方法.</p>
<p>在分析<code>AMS#startActivity()</code>之前, 是否在开始时候碰到过<code>Activity</code>没有在清单文件中声明然后崩溃的现象? 这个步骤是在<code>Instrumentation#execStartActivity()</code>刚才分析<code>ActivityManagerNative.getDefault().startActivity()</code>的下一步. 有一个<code>checkStartActivityResult()</code>,看名字应该是检查的类, 看一下实现.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">checkStartActivityResult</span><span class="o">(</span><span class="kt">int</span> <span class="n">res</span><span class="o">,</span> <span class="n">Object</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">res</span> <span class="o">&gt;=</span> <span class="n">ActivityManager</span><span class="o">.</span><span class="na">START_SUCCESS</span><span class="o">)</span> <span class="o">{</span>
       <span class="k">return</span><span class="o">;</span>
   <span class="o">}</span>
   
   <span class="k">switch</span> <span class="o">(</span><span class="n">res</span><span class="o">)</span> <span class="o">{</span>
       <span class="k">case</span> <span class="n">ActivityManager</span><span class="o">.</span><span class="na">START_INTENT_NOT_RESOLVED</span><span class="o">:</span>
       <span class="k">case</span> <span class="n">ActivityManager</span><span class="o">.</span><span class="na">START_CLASS_NOT_FOUND</span><span class="o">:</span>
           <span class="k">if</span> <span class="o">(</span><span class="n">intent</span> <span class="k">instanceof</span> <span class="n">Intent</span> <span class="o">&amp;&amp;</span> <span class="o">((</span><span class="n">Intent</span><span class="o">)</span><span class="n">intent</span><span class="o">).</span><span class="na">getComponent</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
               <span class="k">throw</span> <span class="k">new</span> <span class="n">ActivityNotFoundException</span><span class="o">(</span>
                       <span class="s">&#34;Unable to find explicit activity class &#34;</span>
                       <span class="o">+</span> <span class="o">((</span><span class="n">Intent</span><span class="o">)</span><span class="n">intent</span><span class="o">).</span><span class="na">getComponent</span><span class="o">().</span><span class="na">toShortString</span><span class="o">()</span>
                       <span class="o">+</span> <span class="s">&#34;; have you declared this activity in your AndroidManifest.xml?&#34;</span><span class="o">);</span>
           <span class="k">throw</span> <span class="k">new</span> <span class="n">ActivityNotFoundException</span><span class="o">(</span>
                   <span class="s">&#34;No Activity found to handle &#34;</span> <span class="o">+</span> <span class="n">intent</span><span class="o">);</span>
       <span class="k">case</span> <span class="n">ActivityManager</span><span class="o">.</span><span class="na">START_PERMISSION_DENIED</span><span class="o">:</span>
           <span class="k">throw</span> <span class="k">new</span> <span class="n">SecurityException</span><span class="o">(</span><span class="s">&#34;Not allowed to start activity &#34;</span>
                   <span class="o">+</span> <span class="n">intent</span><span class="o">);</span>
       <span class="k">case</span> <span class="n">ActivityManager</span><span class="o">.</span><span class="na">START_FORWARD_AND_REQUEST_CONFLICT</span><span class="o">:</span>
           <span class="k">throw</span> <span class="k">new</span> <span class="n">AndroidRuntimeException</span><span class="o">(</span>
                   <span class="s">&#34;FORWARD_RESULT_FLAG used while also requesting a result&#34;</span><span class="o">);</span>
       <span class="k">case</span> <span class="n">ActivityManager</span><span class="o">.</span><span class="na">START_NOT_ACTIVITY</span><span class="o">:</span>
           <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span>
                   <span class="s">&#34;PendingIntent is not an activity&#34;</span><span class="o">);</span>
       <span class="k">case</span> <span class="n">ActivityManager</span><span class="o">.</span><span class="na">START_NOT_VOICE_COMPATIBLE</span><span class="o">:</span>
           <span class="k">throw</span> <span class="k">new</span> <span class="n">SecurityException</span><span class="o">(</span>
                   <span class="s">&#34;Starting under voice control not allowed for: &#34;</span> <span class="o">+</span> <span class="n">intent</span><span class="o">);</span>
       <span class="k">default</span><span class="o">:</span>
           <span class="k">throw</span> <span class="k">new</span> <span class="n">AndroidRuntimeException</span><span class="o">(</span><span class="s">&#34;Unknown error code &#34;</span>
                   <span class="o">+</span> <span class="n">res</span> <span class="o">+</span> <span class="s">&#34; when starting &#34;</span> <span class="o">+</span> <span class="n">intent</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>看出这个方法是一言不合就抛异常. 看<strong>ActivityManager.START_CLASS_NOT_FOUND</strong>这个判断分支抛出的异常是不是很眼熟? 对就是没有在清单文件中注册就在这里抛出. 所以这个方法就是检查启动Activity的结果.</p>
<p><strong>回到AMS的startActivity()</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">startActivity</span><span class="o">(</span><span class="n">IApplicationThread</span> <span class="n">caller</span><span class="o">,</span> <span class="n">String</span> <span class="n">callingPackage</span><span class="o">,</span>
  <span class="n">Intent</span> <span class="n">intent</span><span class="o">,</span> <span class="n">String</span> <span class="n">resolvedType</span><span class="o">,</span> <span class="n">IBinder</span> <span class="n">resultTo</span><span class="o">,</span> <span class="n">String</span> <span class="n">resultWho</span><span class="o">,</span> <span class="kt">int</span> <span class="n">requestCode</span><span class="o">,</span>
  <span class="kt">int</span> <span class="n">startFlags</span><span class="o">,</span> <span class="n">ProfilerInfo</span> <span class="n">profilerInfo</span><span class="o">,</span> <span class="n">Bundle</span> <span class="n">options</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">// 直接调用下面方法
</span><span class="c1"></span><span class="k">return</span> <span class="n">startActivityAsUser</span><span class="o">(</span><span class="n">caller</span><span class="o">,</span> <span class="n">callingPackage</span><span class="o">,</span> <span class="n">intent</span><span class="o">,</span> <span class="n">resolvedType</span><span class="o">,</span> <span class="n">resultTo</span><span class="o">,</span>
  <span class="n">resultWho</span><span class="o">,</span> <span class="n">requestCode</span><span class="o">,</span> <span class="n">startFlags</span><span class="o">,</span> <span class="n">profilerInfo</span><span class="o">,</span> <span class="n">options</span><span class="o">,</span>
  <span class="n">UserHandle</span><span class="o">.</span><span class="na">getCallingUserId</span><span class="o">());</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">startActivityAsUser</span><span class="o">(</span><span class="n">IApplicationThread</span> <span class="n">caller</span><span class="o">,</span> <span class="n">String</span> <span class="n">callingPackage</span><span class="o">,</span>
       <span class="n">Intent</span> <span class="n">intent</span><span class="o">,</span> <span class="n">String</span> <span class="n">resolvedType</span><span class="o">,</span> <span class="n">IBinder</span> <span class="n">resultTo</span><span class="o">,</span> <span class="n">String</span> <span class="n">resultWho</span><span class="o">,</span> <span class="kt">int</span> <span class="n">requestCode</span><span class="o">,</span>
       <span class="kt">int</span> <span class="n">startFlags</span><span class="o">,</span> <span class="n">ProfilerInfo</span> <span class="n">profilerInfo</span><span class="o">,</span> <span class="n">Bundle</span> <span class="n">options</span><span class="o">,</span> <span class="kt">int</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
   <span class="n">enforceNotIsolatedCaller</span><span class="o">(</span><span class="s">&#34;startActivity&#34;</span><span class="o">);</span>
   <span class="n">userId</span> <span class="o">=</span> <span class="n">handleIncomingUser</span><span class="o">(</span><span class="n">Binder</span><span class="o">.</span><span class="na">getCallingPid</span><span class="o">(),</span> <span class="n">Binder</span><span class="o">.</span><span class="na">getCallingUid</span><span class="o">(),</span> <span class="n">userId</span><span class="o">,</span>
           <span class="kc">false</span><span class="o">,</span> <span class="n">ALLOW_FULL_ONLY</span><span class="o">,</span> <span class="s">&#34;startActivity&#34;</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
           
   <span class="c1">// TODO: Switch to user app stacks here.
</span><span class="c1"></span>   <span class="k">return</span> <span class="n">mStackSupervisor</span><span class="o">.</span><span class="na">startActivityMayWait</span><span class="o">(</span><span class="n">caller</span><span class="o">,</span> <span class="o">-</span><span class="n">1</span><span class="o">,</span> <span class="n">callingPackage</span><span class="o">,</span> <span class="n">intent</span><span class="o">,</span>
           <span class="n">resolvedType</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">resultTo</span><span class="o">,</span> <span class="n">resultWho</span><span class="o">,</span> <span class="n">requestCode</span><span class="o">,</span> <span class="n">startFlags</span><span class="o">,</span>
           <span class="n">profilerInfo</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">options</span><span class="o">,</span> <span class="n">userId</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><p><code>Activity</code>启动过程经过两次转移, 最后又转移到了<code>mStackSupervisor.startActivityMayWait()</code>这个方法, 所属类为<code>ActivityStackSupervisor</code>. 在<code>startActivityMayWait()</code>内部又调用了<code>startActivityLocked()</code>这里会返回结果码就是之前<code>checkStartActivityResult()</code>用到的. 继续跟进方法最后会调用<code>startActivityUncheckedLocked()</code>, 然后又调用了<code>ActivityStack#resumeTopActivityLocked()</code>. 这个时候启动过程已经从<code>ActivityStackSupervisor</code>转移到了<code>ActivityStack</code>类中.</p>
<p><strong>具体实现</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">resumeTopActivityLocked</span><span class="o">(</span><span class="n">ActivityRecord</span> <span class="n">prev</span><span class="o">,</span> <span class="n">Bundle</span> <span class="n">options</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">mStackSupervisor</span><span class="o">.</span><span class="na">inResumeTopActivity</span><span class="o">)</span> <span class="o">{</span>
       <span class="c1">// Don&#39;t even start recursing.
</span><span class="c1"></span>       <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="kt">boolean</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
   <span class="k">try</span> <span class="o">{</span>
       <span class="c1">// Protect against recursion.
</span><span class="c1"></span>       <span class="n">mStackSupervisor</span><span class="o">.</span><span class="na">inResumeTopActivity</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
       <span class="k">if</span> <span class="o">(</span><span class="n">mService</span><span class="o">.</span><span class="na">mLockScreenShown</span> <span class="o">==</span> <span class="n">ActivityManagerService</span><span class="o">.</span><span class="na">LOCK_SCREEN_LEAVING</span><span class="o">)</span> <span class="o">{</span>
           <span class="n">mService</span><span class="o">.</span><span class="na">mLockScreenShown</span> <span class="o">=</span> <span class="n">ActivityManagerService</span><span class="o">.</span><span class="na">LOCK_SCREEN_HIDDEN</span><span class="o">;</span>
           <span class="n">mService</span><span class="o">.</span><span class="na">updateSleepIfNeededLocked</span><span class="o">();</span>
       <span class="o">}</span>
       <span class="n">result</span> <span class="o">=</span> <span class="n">resumeTopActivityInnerLocked</span><span class="o">(</span><span class="n">prev</span><span class="o">,</span> <span class="n">options</span><span class="o">);</span>
   <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
       <span class="n">mStackSupervisor</span><span class="o">.</span><span class="na">inResumeTopActivity</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
   <span class="o">}</span>
   <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><p>从上可以看到result是根据调用的<code>resumeTopActivityInnerLocked()</code>返回, 而<code>resumeTopActivityInnerLocked()</code>又调用了<code>ActivityStackSupervisor#startSpecificActivityLocked()</code>方法. 看一下这个方法:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kt">void</span> <span class="nf">startSpecificActivityLocked</span><span class="o">(</span><span class="n">ActivityRecord</span> <span class="n">r</span><span class="o">,</span>
       <span class="kt">boolean</span> <span class="n">andResume</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">checkConfig</span><span class="o">)</span> <span class="o">{</span>
   <span class="c1">// Is this activity&#39;s application already running?
</span><span class="c1"></span>   <span class="n">ProcessRecord</span> <span class="n">app</span> <span class="o">=</span> <span class="n">mService</span><span class="o">.</span><span class="na">getProcessRecordLocked</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">processName</span><span class="o">,</span>
           <span class="n">r</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">uid</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>

   <span class="n">r</span><span class="o">.</span><span class="na">task</span><span class="o">.</span><span class="na">stack</span><span class="o">.</span><span class="na">setLaunchTime</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>

   <span class="k">if</span> <span class="o">(</span><span class="n">app</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">app</span><span class="o">.</span><span class="na">thread</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
       <span class="k">try</span> <span class="o">{</span>
           <span class="k">if</span> <span class="o">((</span><span class="n">r</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">flags</span><span class="o">&amp;</span><span class="n">ActivityInfo</span><span class="o">.</span><span class="na">FLAG_MULTIPROCESS</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span>
                   <span class="o">||</span> <span class="o">!</span><span class="s">&#34;android&#34;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">packageName</span><span class="o">))</span> <span class="o">{</span>
               <span class="n">app</span><span class="o">.</span><span class="na">addPackage</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">packageName</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">versionCode</span><span class="o">,</span>
                       <span class="n">mService</span><span class="o">.</span><span class="na">mProcessStats</span><span class="o">);</span>
           <span class="o">}</span>
           <span class="c1">// 继续进入!!!
</span><span class="c1"></span>           <span class="n">realStartActivityLocked</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">app</span><span class="o">,</span> <span class="n">andResume</span><span class="o">,</span> <span class="n">checkConfig</span><span class="o">);</span>
           <span class="k">return</span><span class="o">;</span>
       <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
           <span class="n">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Exception when starting activity &#34;</span>
                   <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="na">intent</span><span class="o">.</span><span class="na">getComponent</span><span class="o">().</span><span class="na">flattenToShortString</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
       <span class="o">}</span>

       <span class="c1">// If a dead object exception was thrown -- fall through to
</span><span class="c1"></span>       <span class="c1">// restart the application.
</span><span class="c1"></span>   <span class="o">}</span>

   <span class="n">mService</span><span class="o">.</span><span class="na">startProcessLocked</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">processName</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span>
           <span class="s">&#34;activity&#34;</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">intent</span><span class="o">.</span><span class="na">getComponent</span><span class="o">(),</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
<span class="o">}</span>

</code></pre></div><p>这个方法又进入了<code>realStartActivityLocked()</code>. 在这个方法中有如下一段代码:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"> <span class="n">app</span><span class="o">.</span><span class="na">thread</span><span class="o">.</span><span class="na">scheduleLaunchActivity</span><span class="o">(</span><span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">intent</span><span class="o">),</span> <span class="n">r</span><span class="o">.</span><span class="na">appToken</span><span class="o">,</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">identityHashCode</span><span class="o">(</span><span class="n">r</span><span class="o">),</span> <span class="n">r</span><span class="o">.</span><span class="na">info</span><span class="o">,</span> <span class="k">new</span> <span class="n">Configuration</span><span class="o">(</span><span class="n">mService</span><span class="o">.</span><span class="na">mConfiguration</span><span class="o">),</span>
                    <span class="n">r</span><span class="o">.</span><span class="na">compat</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">launchedFromPackage</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">task</span><span class="o">.</span><span class="na">voiceInteractor</span><span class="o">,</span> <span class="n">app</span><span class="o">.</span><span class="na">repProcState</span><span class="o">,</span>
                    <span class="n">r</span><span class="o">.</span><span class="na">icicle</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">persistentState</span><span class="o">,</span> <span class="n">results</span><span class="o">,</span> <span class="n">newIntents</span><span class="o">,</span> <span class="o">!</span><span class="n">andResume</span><span class="o">,</span>
                    <span class="n">mService</span><span class="o">.</span><span class="na">isNextTransitionForward</span><span class="o">(),</span> <span class="n">profilerInfo</span><span class="o">);</span>
</code></pre></div><p>先整理一下刚才的调用过程, 我已经照着书上跟的不知所以然了&hellip;. = =</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="activity_01.png"
        data-srcset="activity_01.png, activity_01.png 1.5x, activity_01.png 2x"
        data-sizes="auto"
        alt="activity_01.png"
        title="activity_01.png" /></p>
<p>继续看刚才<code>app.thread.scheduleLaunchActivity()</code>这个方法. 其中<code>app.thread</code>类型为<code>IApplicationThread</code>, 这个玩意继承了<code>IInterface</code>接口, 所以他也是一个<code>Binder</code>类型的接口接口. 从<code>IApplicationThread</code>声明的接口方法可以看出, 其内部包含了大量启动和停止<code>Activity</code>的接口, 此外还包含了<code>Service</code>的启动与停止. 可以猜想, <code>IApplicationThread</code>这个<code>Binder</code>接口的是实现者完成了大量和<code>Activity</code>以及<code>Service</code>启动和停止的相关功能.</p>
<p><strong>那<code>IApplicationThread</code>的实现者是哪个类? 在<code>ActivityThread</code>中的内部类有一个<code>ApplicationThread</code>,看看定义</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kd">class</span> <span class="nc">ApplicationThread</span> <span class="kd">extends</span> <span class="n">ApplicationThreadNative</span>

<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">ApplicationThreadNative</span> <span class="kd">extends</span> <span class="n">Binder</span>
        <span class="kd">implements</span> <span class="n">IApplicationThread</span>

</code></pre></div><p>可以看到<code>ApplicationThread</code>的继承关系, 而查看<code>ApplicationThreadNative</code>的作用其实和系统AIDL文件生成的类是一样的.</p>
<p>在<code>ApplicationThreadNative</code>的内部, 还有一个<code>ApplicationThreadProxy</code>类, 眼熟吧在第二章讲解的时候<strong>aidl生成的java文件中</strong>也有一个内部的代理类. 所以<code>ApplicationThreadNative</code>就是<code>IApplicationThread</code>的实现者, 由于<code>ApplicationThreadNative</code>被系统定义为抽象类, 所以<code>ApplicationThread</code>就成了<code>IApplicationThread</code>的实现者</p>
<hr>
<p>绕了一大圈, <strong>Activity</strong>启动过程最终回到了<code>ApplicationThread</code>中, <code>ApplicationThread</code>通过<code>scheduleLaunchActivity()</code>来启动Activity.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">scheduleLaunchActivity</span><span class="o">(</span><span class="n">Intent</span> <span class="n">intent</span><span class="o">,</span> <span class="n">IBinder</span> <span class="n">token</span><span class="o">,</span> <span class="kt">int</span> <span class="n">ident</span><span class="o">,</span>
                <span class="n">ActivityInfo</span> <span class="n">info</span><span class="o">,</span> <span class="n">Configuration</span> <span class="n">curConfig</span><span class="o">,</span> <span class="n">CompatibilityInfo</span> <span class="n">compatInfo</span><span class="o">,</span>
                <span class="n">String</span> <span class="n">referrer</span><span class="o">,</span> <span class="n">IVoiceInteractor</span> <span class="n">voiceInteractor</span><span class="o">,</span> <span class="kt">int</span> <span class="n">procState</span><span class="o">,</span> <span class="n">Bundle</span> <span class="n">state</span><span class="o">,</span>
                <span class="n">PersistableBundle</span> <span class="n">persistentState</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">ResultInfo</span><span class="o">&gt;</span> <span class="n">pendingResults</span><span class="o">,</span>
                <span class="n">List</span><span class="o">&lt;</span><span class="n">ReferrerIntent</span><span class="o">&gt;</span> <span class="n">pendingNewIntents</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">notResumed</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">isForward</span><span class="o">,</span>
                <span class="n">ProfilerInfo</span> <span class="n">profilerInfo</span><span class="o">)</span> <span class="o">{</span>

            <span class="n">updateProcessState</span><span class="o">(</span><span class="n">procState</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>

            <span class="n">ActivityClientRecord</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ActivityClientRecord</span><span class="o">();</span>
            <span class="n">r</span><span class="o">.</span><span class="na">token</span> <span class="o">=</span> <span class="n">token</span><span class="o">;</span>
            <span class="n">r</span><span class="o">.</span><span class="na">ident</span> <span class="o">=</span> <span class="n">ident</span><span class="o">;</span>
            <span class="n">r</span><span class="o">.</span><span class="na">intent</span> <span class="o">=</span> <span class="n">intent</span><span class="o">;</span>
            <span class="n">r</span><span class="o">.</span><span class="na">referrer</span> <span class="o">=</span> <span class="n">referrer</span><span class="o">;</span>
            <span class="n">r</span><span class="o">.</span><span class="na">voiceInteractor</span> <span class="o">=</span> <span class="n">voiceInteractor</span><span class="o">;</span>
            <span class="n">r</span><span class="o">.</span><span class="na">activityInfo</span> <span class="o">=</span> <span class="n">info</span><span class="o">;</span>
            <span class="n">r</span><span class="o">.</span><span class="na">compatInfo</span> <span class="o">=</span> <span class="n">compatInfo</span><span class="o">;</span>
            <span class="n">r</span><span class="o">.</span><span class="na">state</span> <span class="o">=</span> <span class="n">state</span><span class="o">;</span>
            <span class="n">r</span><span class="o">.</span><span class="na">persistentState</span> <span class="o">=</span> <span class="n">persistentState</span><span class="o">;</span>
            <span class="n">r</span><span class="o">.</span><span class="na">pendingResults</span> <span class="o">=</span> <span class="n">pendingResults</span><span class="o">;</span>
            <span class="n">r</span><span class="o">.</span><span class="na">pendingIntents</span> <span class="o">=</span> <span class="n">pendingNewIntents</span><span class="o">;</span>
            <span class="n">r</span><span class="o">.</span><span class="na">startsNotResumed</span> <span class="o">=</span> <span class="n">notResumed</span><span class="o">;</span>
            <span class="n">r</span><span class="o">.</span><span class="na">isForward</span> <span class="o">=</span> <span class="n">isForward</span><span class="o">;</span>
            <span class="n">r</span><span class="o">.</span><span class="na">profilerInfo</span> <span class="o">=</span> <span class="n">profilerInfo</span><span class="o">;</span>
            <span class="n">updatePendingConfiguration</span><span class="o">(</span><span class="n">curConfig</span><span class="o">);</span>
            
            <span class="n">sendMessage</span><span class="o">(</span><span class="n">H</span><span class="o">.</span><span class="na">LAUNCH_ACTIVITY</span><span class="o">,</span> <span class="n">r</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><p>这段代码做的就是封装一个<code>Activity的记录信息</code>交给名字叫<strong>H</strong>的一个Handler对象去处理, 继续跟进看看里面的实现</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">sendMessage</span><span class="o">(</span><span class="kt">int</span> <span class="n">what</span><span class="o">,</span> <span class="n">Object</span> <span class="n">obj</span><span class="o">,</span> <span class="kt">int</span> <span class="n">arg1</span><span class="o">,</span> <span class="kt">int</span> <span class="n">arg2</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">async</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG_MESSAGES</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span>
       <span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;SCHEDULE &#34;</span> <span class="o">+</span> <span class="n">what</span> <span class="o">+</span> <span class="s">&#34; &#34;</span> <span class="o">+</span> <span class="n">mH</span><span class="o">.</span><span class="na">codeToString</span><span class="o">(</span><span class="n">what</span><span class="o">)</span>
       <span class="o">+</span> <span class="s">&#34;: &#34;</span> <span class="o">+</span> <span class="n">arg1</span> <span class="o">+</span> <span class="s">&#34; / &#34;</span> <span class="o">+</span> <span class="n">obj</span><span class="o">);</span>
   <span class="n">Message</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="o">.</span><span class="na">obtain</span><span class="o">();</span>
   <span class="n">msg</span><span class="o">.</span><span class="na">what</span> <span class="o">=</span> <span class="n">what</span><span class="o">;</span>
   <span class="n">msg</span><span class="o">.</span><span class="na">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="o">;</span>
   <span class="n">msg</span><span class="o">.</span><span class="na">arg1</span> <span class="o">=</span> <span class="n">arg1</span><span class="o">;</span>
   <span class="n">msg</span><span class="o">.</span><span class="na">arg2</span> <span class="o">=</span> <span class="n">arg2</span><span class="o">;</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">async</span><span class="o">)</span> <span class="o">{</span>
       <span class="n">msg</span><span class="o">.</span><span class="na">setAsynchronous</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="n">mH</span><span class="o">.</span><span class="na">sendMessage</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><p>额, 没啥好瞅的就是封装一个<code>message</code>发送了一个消息. 好吧 那看看<code>Handler</code>接收的时候是如何处理的吧. 这个类里面对<code>Handler</code>进行了包装, 包装的类就是一个<code>H</code>的内部类.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kd">class</span> <span class="nc">H</span> <span class="kd">extends</span> <span class="n">Handler</span> <span class="o">{</span>
   <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LAUNCH_ACTIVITY</span>         <span class="o">=</span> <span class="n">100</span><span class="o">;</span>
   <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">PAUSE_ACTIVITY</span>          <span class="o">=</span> <span class="n">101</span><span class="o">;</span>
   <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">PAUSE_ACTIVITY_FINISHING</span><span class="o">=</span> <span class="n">102</span><span class="o">;</span>
   <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">STOP_ACTIVITY_SHOW</span>      <span class="o">=</span> <span class="n">103</span><span class="o">;</span>
   <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">STOP_ACTIVITY_HIDE</span>      <span class="o">=</span> <span class="n">104</span><span class="o">;</span>
 <span class="c1">//这里省略一堆常量声明
</span><span class="c1"></span> <span class="c1">//在省略一堆switch分支, 直接看具体的消息处理
</span><span class="c1"></span>   
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleMessage</span><span class="o">(</span><span class="n">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
       <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG_MESSAGES</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;&gt;&gt;&gt; handling: &#34;</span> <span class="o">+</span> <span class="n">codeToString</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">what</span><span class="o">));</span>
       <span class="k">switch</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">what</span><span class="o">)</span> <span class="o">{</span>
           <span class="k">case</span> <span class="n">LAUNCH_ACTIVITY</span><span class="o">:</span> <span class="o">{</span>
               <span class="n">Trace</span><span class="o">.</span><span class="na">traceBegin</span><span class="o">(</span><span class="n">Trace</span><span class="o">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="o">,</span> <span class="s">&#34;activityStart&#34;</span><span class="o">);</span>
               <span class="kd">final</span> <span class="n">ActivityClientRecord</span> <span class="n">r</span> <span class="o">=</span> <span class="o">(</span><span class="n">ActivityClientRecord</span><span class="o">)</span> <span class="n">msg</span><span class="o">.</span><span class="na">obj</span><span class="o">;</span>

               <span class="n">r</span><span class="o">.</span><span class="na">packageInfo</span> <span class="o">=</span> <span class="n">getPackageInfoNoCheck</span><span class="o">(</span>
                       <span class="n">r</span><span class="o">.</span><span class="na">activityInfo</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">compatInfo</span><span class="o">);</span>
               <span class="n">handleLaunchActivity</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
               <span class="n">Trace</span><span class="o">.</span><span class="na">traceEnd</span><span class="o">(</span><span class="n">Trace</span><span class="o">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="o">);</span>
           <span class="o">}</span> <span class="k">break</span><span class="o">;</span>
           <span class="k">case</span> <span class="n">PAUSE_ACTIVITY</span><span class="o">:</span>
               <span class="n">Trace</span><span class="o">.</span><span class="na">traceBegin</span><span class="o">(</span><span class="n">Trace</span><span class="o">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="o">,</span> <span class="s">&#34;activityPause&#34;</span><span class="o">);</span>
               <span class="n">handlePauseActivity</span><span class="o">((</span><span class="n">IBinder</span><span class="o">)</span><span class="n">msg</span><span class="o">.</span><span class="na">obj</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">arg1</span><span class="o">&amp;</span><span class="n">1</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">,</span> <span class="n">msg</span><span class="o">.</span><span class="na">arg2</span><span class="o">,</span>
                       <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">arg1</span><span class="o">&amp;</span><span class="n">2</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">);</span>
               <span class="n">maybeSnapshot</span><span class="o">();</span>
               <span class="n">Trace</span><span class="o">.</span><span class="na">traceEnd</span><span class="o">(</span><span class="n">Trace</span><span class="o">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="o">);</span>
               <span class="k">break</span><span class="o">;</span>
           <span class="k">case</span> <span class="n">PAUSE_ACTIVITY_FINISHING</span><span class="o">:</span>
               <span class="n">Trace</span><span class="o">.</span><span class="na">traceBegin</span><span class="o">(</span><span class="n">Trace</span><span class="o">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="o">,</span> <span class="s">&#34;activityPause&#34;</span><span class="o">);</span>
               <span class="n">handlePauseActivity</span><span class="o">((</span><span class="n">IBinder</span><span class="o">)</span><span class="n">msg</span><span class="o">.</span><span class="na">obj</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">arg1</span><span class="o">&amp;</span><span class="n">1</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">,</span> <span class="n">msg</span><span class="o">.</span><span class="na">arg2</span><span class="o">,</span>
                       <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">arg1</span><span class="o">&amp;</span><span class="n">1</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">);</span>
               <span class="n">Trace</span><span class="o">.</span><span class="na">traceEnd</span><span class="o">(</span><span class="n">Trace</span><span class="o">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="o">);</span>
               <span class="k">break</span><span class="o">;</span>
            <span class="c1">//这里又省去了一大坨的case分支
</span><span class="c1"></span>        <span class="o">}</span>
       <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG_MESSAGES</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;&lt;&lt;&lt; done: &#34;</span> <span class="o">+</span> <span class="n">codeToString</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">what</span><span class="o">));</span>
   <span class="o">}</span>  
</code></pre></div><p>我们目前只关心<code>LAUNCH_ACTIVITY</code>这个标记, 这个内部我们可以看到通过<code>handleLaunchActivity()</code>方法来实现.  这个方法内部通过**<code>PerformLaunchActivity()</code>**方法最终完成了<code>Activity</code>对象的创建和启动过程. 并且<code>ActivityThread</code>通过<code>handleResumeActivity()</code>方法来调用被启动的<code>onResume()</code>这一生命周期方法.</p>
<p><strong>那么<code>PerformLaunchActivity()</code>究竟做了那几件事情完成了<code>Activity</code>的形成呢.</strong></p>
<hr>
<p><strong>1. 从ActivityClientRecord中获取待启动的Activity信息</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="k">if</span> <span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">packageInfo</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">r</span><span class="o">.</span><span class="na">packageInfo</span> <span class="o">=</span> <span class="n">getPackageInfo</span><span class="o">(</span><span class="n">aInfo</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">compatInfo</span><span class="o">,</span>
          <span class="n">Context</span><span class="o">.</span><span class="na">CONTEXT_INCLUDE_CODE</span><span class="o">);</span>
<span class="o">}</span>

<span class="n">ComponentName</span> <span class="n">component</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">intent</span><span class="o">.</span><span class="na">getComponent</span><span class="o">();</span>
<span class="k">if</span> <span class="o">(</span><span class="n">component</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">component</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">intent</span><span class="o">.</span><span class="na">resolveActivity</span><span class="o">(</span>
      <span class="n">mInitialApplication</span><span class="o">.</span><span class="na">getPackageManager</span><span class="o">());</span>
  <span class="n">r</span><span class="o">.</span><span class="na">intent</span><span class="o">.</span><span class="na">setComponent</span><span class="o">(</span><span class="n">component</span><span class="o">);</span>
<span class="o">}</span>

<span class="k">if</span> <span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">activityInfo</span><span class="o">.</span><span class="na">targetActivity</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">component</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ComponentName</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">activityInfo</span><span class="o">.</span><span class="na">packageName</span><span class="o">,</span>
          <span class="n">r</span><span class="o">.</span><span class="na">activityInfo</span><span class="o">.</span><span class="na">targetActivity</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><p><strong>2.通过Instrumentation的newActivity方法使用类加载器创建Activity对象</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">ClassLoader</span> <span class="n">cl</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">packageInfo</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">();</span>
<span class="n">activity</span> <span class="o">=</span> <span class="n">mInstrumentation</span><span class="o">.</span><span class="na">newActivity</span><span class="o">(</span>
        <span class="n">cl</span><span class="o">,</span> <span class="n">component</span><span class="o">.</span><span class="na">getClassName</span><span class="o">(),</span> <span class="n">r</span><span class="o">.</span><span class="na">intent</span><span class="o">);</span>
<span class="n">StrictMode</span><span class="o">.</span><span class="na">incrementExpectedActivityCount</span><span class="o">(</span><span class="n">activity</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
<span class="n">r</span><span class="o">.</span><span class="na">intent</span><span class="o">.</span><span class="na">setExtrasClassLoader</span><span class="o">(</span><span class="n">cl</span><span class="o">);</span>
<span class="n">r</span><span class="o">.</span><span class="na">intent</span><span class="o">.</span><span class="na">prepareToEnterProcess</span><span class="o">();</span>
<span class="k">if</span> <span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">state</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">r</span><span class="o">.</span><span class="na">state</span><span class="o">.</span><span class="na">setClassLoader</span><span class="o">(</span><span class="n">cl</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><p><strong>3.通过LoadedApk的makeApplication()方法来尝试创建Application对象</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java">    <span class="kd">public</span> <span class="n">Application</span> <span class="nf">makeApplication</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">forceDefaultAppClass</span><span class="o">,</span>
            <span class="n">Instrumentation</span> <span class="n">instrumentation</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mApplication</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">mApplication</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="n">Application</span> <span class="n">app</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="n">String</span> <span class="n">appClass</span> <span class="o">=</span> <span class="n">mApplicationInfo</span><span class="o">.</span><span class="na">className</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">forceDefaultAppClass</span> <span class="o">||</span> <span class="o">(</span><span class="n">appClass</span> <span class="o">==</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">appClass</span> <span class="o">=</span> <span class="s">&#34;android.app.Application&#34;</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">ClassLoader</span> <span class="n">cl</span> <span class="o">=</span> <span class="n">getClassLoader</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">mPackageName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&#34;android&#34;</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">initializeJavaContextClassLoader</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="n">ContextImpl</span> <span class="n">appContext</span> <span class="o">=</span> <span class="n">ContextImpl</span><span class="o">.</span><span class="na">createAppContext</span><span class="o">(</span><span class="n">mActivityThread</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
            <span class="n">app</span> <span class="o">=</span> <span class="n">mActivityThread</span><span class="o">.</span><span class="na">mInstrumentation</span><span class="o">.</span><span class="na">newApplication</span><span class="o">(</span>
                    <span class="n">cl</span><span class="o">,</span> <span class="n">appClass</span><span class="o">,</span> <span class="n">appContext</span><span class="o">);</span>
            <span class="n">appContext</span><span class="o">.</span><span class="na">setOuterContext</span><span class="o">(</span><span class="n">app</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">mActivityThread</span><span class="o">.</span><span class="na">mInstrumentation</span><span class="o">.</span><span class="na">onException</span><span class="o">(</span><span class="n">app</span><span class="o">,</span> <span class="n">e</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span>
                    <span class="s">&#34;Unable to instantiate application &#34;</span> <span class="o">+</span> <span class="n">appClass</span>
                    <span class="o">+</span> <span class="s">&#34;: &#34;</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">mActivityThread</span><span class="o">.</span><span class="na">mAllApplications</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">app</span><span class="o">);</span>
        <span class="n">mApplication</span> <span class="o">=</span> <span class="n">app</span><span class="o">;</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">instrumentation</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">instrumentation</span><span class="o">.</span><span class="na">callApplicationOnCreate</span><span class="o">(</span><span class="n">app</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">instrumentation</span><span class="o">.</span><span class="na">onException</span><span class="o">(</span><span class="n">app</span><span class="o">,</span> <span class="n">e</span><span class="o">))</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span>
                        <span class="s">&#34;Unable to create application &#34;</span> <span class="o">+</span> <span class="n">app</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span>
                        <span class="o">+</span> <span class="s">&#34;: &#34;</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="c1">// Rewrite the R &#39;constants&#39; for all library apks.
</span><span class="c1"></span>        <span class="n">SparseArray</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">packageIdentifiers</span> <span class="o">=</span> <span class="n">getAssets</span><span class="o">(</span><span class="n">mActivityThread</span><span class="o">)</span>
                <span class="o">.</span><span class="na">getAssignedPackageIdentifiers</span><span class="o">();</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">N</span> <span class="o">=</span> <span class="n">packageIdentifiers</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">packageIdentifiers</span><span class="o">.</span><span class="na">keyAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">0x01</span> <span class="o">||</span> <span class="n">id</span> <span class="o">==</span> <span class="n">0x7f</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">continue</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="n">rewriteRValues</span><span class="o">(</span><span class="n">getClassLoader</span><span class="o">(),</span> <span class="n">packageIdentifiers</span><span class="o">.</span><span class="na">valueAt</span><span class="o">(</span><span class="n">i</span><span class="o">),</span> <span class="n">id</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">app</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div><p>从这个方法中可以看到, 如果<code>Application</code>这个对象已经被创建过, 那么就不会再重复创建了, 这也就意味着一个应用只有一个<code>Application</code>对象的原因. <code>Application</code>对象的创建也是通过<code>Instrumentation</code>类来完成, 这个过程和Activity对象的创建是一致的, 都是通过类加载器来实现. <code>Application</code>创建完毕后, 系统会通过<code>Instrumentation</code>的<code>callApplicationOnCreate()</code>方法来调用<code>Application#onCreate()</code>方法.</p>
<p><strong>4. 创建ContextImpl对象并通过Activity的attach方法来完成重要数据的初始化</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"> <span class="n">Context</span> <span class="n">appContext</span> <span class="o">=</span> <span class="n">createBaseContextForActivity</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">activity</span><span class="o">);</span>
                <span class="n">CharSequence</span> <span class="n">title</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">activityInfo</span><span class="o">.</span><span class="na">loadLabel</span><span class="o">(</span><span class="n">appContext</span><span class="o">.</span><span class="na">getPackageManager</span><span class="o">());</span>
                <span class="n">Configuration</span> <span class="n">config</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Configuration</span><span class="o">(</span><span class="n">mCompatConfiguration</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG_CONFIGURATION</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Launching activity &#34;</span>
                        <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="na">activityInfo</span><span class="o">.</span><span class="na">name</span> <span class="o">+</span> <span class="s">&#34; with config &#34;</span> <span class="o">+</span> <span class="n">config</span><span class="o">);</span>
                <span class="n">activity</span><span class="o">.</span><span class="na">attach</span><span class="o">(</span><span class="n">appContext</span><span class="o">,</span> <span class="k">this</span><span class="o">,</span> <span class="n">getInstrumentation</span><span class="o">(),</span> <span class="n">r</span><span class="o">.</span><span class="na">token</span><span class="o">,</span>
                        <span class="n">r</span><span class="o">.</span><span class="na">ident</span><span class="o">,</span> <span class="n">app</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">intent</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">activityInfo</span><span class="o">,</span> <span class="n">title</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">parent</span><span class="o">,</span>
                        <span class="n">r</span><span class="o">.</span><span class="na">embeddedID</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">lastNonConfigurationInstances</span><span class="o">,</span> <span class="n">config</span><span class="o">,</span>
                        <span class="n">r</span><span class="o">.</span><span class="na">referrer</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">voiceInteractor</span><span class="o">);</span>
</code></pre></div><p><code>ContextImpl</code>是一个很重要的数据结构, 它是Context的具体实现, <code>Context</code>中的大部分逻辑都是由<code>ContentImpl</code>来完成的. ContextImpl是通过Activity的<code>attach()</code>方法来和Activity建立关联的,除此之外, 在<code>attach()</code>中Activity还会完成Window的创建并建立自己和Window的关联, 这样当Window接收到外部输入事件收就可以将事件传递给Activity.</p>
<p><strong>5. 调用Activity的onCreate()方法</strong></p>
<p><code> mInstrumentation.callActivityOnCreate(activity, r.state);</code>, 由于Activity的<code>onCreate()</code>已经被调用, 这也意味着Activity已经完成整个启动过程.</p>
<h2 id="service的工作流程">Service的工作流程</h2>
<h3 id="service的启动过程">Service的启动过程</h3>
<p>同样从<code>ContextImpl#startService()</code>这个方法作为入口.</p>
<p>这个方法会调用<code>startServiceCommon()</code>并返回. 这个方法内部通过<code> ActivityManagerNative.getDefault()</code>获得一个<code>AMS</code>并调用<code>startService()</code>开启一个服务. 在这里通过<code>AMS</code>来启动一个服务的行为是属于远程调用的过程.</p>
<p>看一下<code>startService()</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java">    <span class="kd">public</span> <span class="n">ComponentName</span> <span class="nf">startService</span><span class="o">(</span><span class="n">IApplicationThread</span> <span class="n">caller</span><span class="o">,</span> <span class="n">Intent</span> <span class="n">service</span><span class="o">,</span>
            <span class="n">String</span> <span class="n">resolvedType</span><span class="o">,</span> <span class="kt">int</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">enforceNotIsolatedCaller</span><span class="o">(</span><span class="s">&#34;startService&#34;</span><span class="o">);</span>
        <span class="c1">// Refuse possible leaked file descriptors
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">service</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">service</span><span class="o">.</span><span class="na">hasFileDescriptors</span><span class="o">()</span> <span class="o">==</span> <span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;File descriptors passed in Intent&#34;</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG_SERVICE</span><span class="o">)</span>
            <span class="n">Slog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;startService: &#34;</span> <span class="o">+</span> <span class="n">service</span> <span class="o">+</span> <span class="s">&#34; type=&#34;</span> <span class="o">+</span> <span class="n">resolvedType</span><span class="o">);</span>
        <span class="kd">synchronized</span><span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="kt">int</span> <span class="n">callingPid</span> <span class="o">=</span> <span class="n">Binder</span><span class="o">.</span><span class="na">getCallingPid</span><span class="o">();</span>
            <span class="kd">final</span> <span class="kt">int</span> <span class="n">callingUid</span> <span class="o">=</span> <span class="n">Binder</span><span class="o">.</span><span class="na">getCallingUid</span><span class="o">();</span>
            <span class="kd">final</span> <span class="kt">long</span> <span class="n">origId</span> <span class="o">=</span> <span class="n">Binder</span><span class="o">.</span><span class="na">clearCallingIdentity</span><span class="o">();</span>
            <span class="n">ComponentName</span> <span class="n">res</span> <span class="o">=</span> <span class="n">mServices</span><span class="o">.</span><span class="na">startServiceLocked</span><span class="o">(</span><span class="n">caller</span><span class="o">,</span> <span class="n">service</span><span class="o">,</span>
                    <span class="n">resolvedType</span><span class="o">,</span> <span class="n">callingPid</span><span class="o">,</span> <span class="n">callingUid</span><span class="o">,</span> <span class="n">userId</span><span class="o">);</span>
            <span class="n">Binder</span><span class="o">.</span><span class="na">restoreCallingIdentity</span><span class="o">(</span><span class="n">origId</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">res</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div><p>这段主要就是<code>AMS</code>通过<code>mServices</code>这个对象来完成<code>Service</code>后续的启动过程. 这里<code>mService</code>的对象类型是<code>ActivityServices</code>(这是一个辅助AMS进行Service管理的类, 包括Service的启动,绑定和停止等).</p>
<p>这里调用了<code>mServices.startServiceLocked()</code>然后这个方法最后又调用了<code>startServiceInnerLocked()</code>, 实现如下.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"> <span class="n">ComponentName</span> <span class="nf">startServiceInnerLocked</span><span class="o">(</span><span class="n">ServiceMap</span> <span class="n">smap</span><span class="o">,</span> <span class="n">Intent</span> <span class="n">service</span><span class="o">,</span>
            <span class="n">ServiceRecord</span> <span class="n">r</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">callerFg</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">addToStarting</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ProcessStats</span><span class="o">.</span><span class="na">ServiceState</span> <span class="n">stracker</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">getTracker</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">stracker</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">stracker</span><span class="o">.</span><span class="na">setStarted</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="n">mAm</span><span class="o">.</span><span class="na">mProcessStats</span><span class="o">.</span><span class="na">getMemFactorLocked</span><span class="o">(),</span> <span class="n">r</span><span class="o">.</span><span class="na">lastActivity</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">r</span><span class="o">.</span><span class="na">callStart</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">stats</span><span class="o">.</span><span class="na">getBatteryStats</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">r</span><span class="o">.</span><span class="na">stats</span><span class="o">.</span><span class="na">startRunningLocked</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">String</span> <span class="n">error</span> <span class="o">=</span> <span class="n">bringUpServiceLocked</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">service</span><span class="o">.</span><span class="na">getFlags</span><span class="o">(),</span> <span class="n">callerFg</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">error</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">ComponentName</span><span class="o">(</span><span class="s">&#34;!!&#34;</span><span class="o">,</span> <span class="n">error</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">startRequested</span> <span class="o">&amp;&amp;</span> <span class="n">addToStarting</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">boolean</span> <span class="n">first</span> <span class="o">=</span> <span class="n">smap</span><span class="o">.</span><span class="na">mStartingBackground</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="n">0</span><span class="o">;</span>
            <span class="n">smap</span><span class="o">.</span><span class="na">mStartingBackground</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
            <span class="n">r</span><span class="o">.</span><span class="na">startingBgTimeout</span> <span class="o">=</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">()</span> <span class="o">+</span> <span class="n">BG_START_TIMEOUT</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG_DELAYED_SERVICE</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">RuntimeException</span> <span class="n">here</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="s">&#34;here&#34;</span><span class="o">);</span>
                <span class="n">here</span><span class="o">.</span><span class="na">fillInStackTrace</span><span class="o">();</span>
                <span class="n">Slog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Starting background (first=&#34;</span> <span class="o">+</span> <span class="n">first</span> <span class="o">+</span> <span class="s">&#34;): &#34;</span> <span class="o">+</span> <span class="n">r</span><span class="o">,</span> <span class="n">here</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG_DELAYED_STARTS</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Slog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Starting background (first=&#34;</span> <span class="o">+</span> <span class="n">first</span> <span class="o">+</span> <span class="s">&#34;): &#34;</span> <span class="o">+</span> <span class="n">r</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">first</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">smap</span><span class="o">.</span><span class="na">rescheduleDelayedStarts</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">callerFg</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">smap</span><span class="o">.</span><span class="na">ensureNotStartingBackground</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="na">name</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div><p><code>ServiceRecord</code>描述的是一个Service记录, <code>ServiceRecord</code>一直贯穿着整个Service的启动过程. <code>startServiceInnerLocked()</code>方法并没有完成具体的启动工作, 而是把后续的工作交给了<code>bringUpServiceLocked()</code>,在<code>bringUpServiceLocked()</code>又调用了<code>realStartServiceLocked()</code>方法. 这个方法算是真正的启动一个<code>Service</code>.</p>
<p>**<code>realStartServiceLocked()</code>**首先通过<code>app.thread.scheduleCreateService()</code>方法来创建<code>Service</code>对象并调用其<code>onCreate()</code>, 接着再通过<code>sendServiceArgsLoceked()</code>方法来调用Service的其他方法, 比如<code>onStartCommond</code>这两个过程均是进程间通信. <code>app.thread</code>是一个<code>Binder</code>对象. 具体实现看<code>ApplicationThread</code>即可. 在<code>Activity</code>启动流程的时候已经解释过了.</p>
<p>所以只查看<code>Application</code>对<code>Service</code>的启动过程的处理即可. 这对应着它的<code>scheduleCreateService()</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java">   <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">scheduleCreateService</span><span class="o">(</span><span class="n">IBinder</span> <span class="n">token</span><span class="o">,</span>
           <span class="n">ServiceInfo</span> <span class="n">info</span><span class="o">,</span> <span class="n">CompatibilityInfo</span> <span class="n">compatInfo</span><span class="o">,</span> <span class="kt">int</span> <span class="n">processState</span><span class="o">)</span> <span class="o">{</span>
       <span class="n">updateProcessState</span><span class="o">(</span><span class="n">processState</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
       <span class="n">CreateServiceData</span> <span class="n">s</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CreateServiceData</span><span class="o">();</span>
       <span class="n">s</span><span class="o">.</span><span class="na">token</span> <span class="o">=</span> <span class="n">token</span><span class="o">;</span>
       <span class="n">s</span><span class="o">.</span><span class="na">info</span> <span class="o">=</span> <span class="n">info</span><span class="o">;</span>
       <span class="n">s</span><span class="o">.</span><span class="na">compatInfo</span> <span class="o">=</span> <span class="n">compatInfo</span><span class="o">;</span>

       <span class="n">sendMessage</span><span class="o">(</span><span class="n">H</span><span class="o">.</span><span class="na">CREATE_SERVICE</span><span class="o">,</span> <span class="n">s</span><span class="o">);</span>
   <span class="o">}</span>
</code></pre></div><p>这个过程和<code>Activity</code>类似, 都是通过<code>H</code>来完成.  最终处理消息接收结果会调用<code>handleCreateService</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">handleCreateService</span><span class="o">(</span><span class="n">CreateServiceData</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
      
        <span class="n">unscheduleGcIdler</span><span class="o">();</span>

        <span class="n">LoadedApk</span> <span class="n">packageInfo</span> <span class="o">=</span> <span class="n">getPackageInfoNoCheck</span><span class="o">(</span>
                <span class="n">data</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">,</span> <span class="n">data</span><span class="o">.</span><span class="na">compatInfo</span><span class="o">);</span>
        <span class="n">Service</span> <span class="n">service</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">ClassLoader</span> <span class="n">cl</span> <span class="o">=</span> <span class="n">packageInfo</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">();</span>
            <span class="n">service</span> <span class="o">=</span> <span class="o">(</span><span class="n">Service</span><span class="o">)</span> <span class="n">cl</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">name</span><span class="o">).</span><span class="na">newInstance</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">mInstrumentation</span><span class="o">.</span><span class="na">onException</span><span class="o">(</span><span class="n">service</span><span class="o">,</span> <span class="n">e</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span>
                    <span class="s">&#34;Unable to instantiate service &#34;</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">name</span>
                    <span class="o">+</span> <span class="s">&#34;: &#34;</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">localLOGV</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Creating service &#34;</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>

            <span class="n">ContextImpl</span> <span class="n">context</span> <span class="o">=</span> <span class="n">ContextImpl</span><span class="o">.</span><span class="na">createAppContext</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">packageInfo</span><span class="o">);</span>
            <span class="n">context</span><span class="o">.</span><span class="na">setOuterContext</span><span class="o">(</span><span class="n">service</span><span class="o">);</span>

            <span class="n">Application</span> <span class="n">app</span> <span class="o">=</span> <span class="n">packageInfo</span><span class="o">.</span><span class="na">makeApplication</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="n">mInstrumentation</span><span class="o">);</span>
            <span class="c1">//----------------
</span><span class="c1"></span>            <span class="n">service</span><span class="o">.</span><span class="na">attach</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="k">this</span><span class="o">,</span> <span class="n">data</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">name</span><span class="o">,</span> <span class="n">data</span><span class="o">.</span><span class="na">token</span><span class="o">,</span> <span class="n">app</span><span class="o">,</span>
                    <span class="n">ActivityManagerNative</span><span class="o">.</span><span class="na">getDefault</span><span class="o">());</span>
            <span class="n">service</span><span class="o">.</span><span class="na">onCreate</span><span class="o">();</span>
            <span class="c1">//---------------
</span><span class="c1"></span>            <span class="n">mServices</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">token</span><span class="o">,</span> <span class="n">service</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">ActivityManagerNative</span><span class="o">.</span><span class="na">getDefault</span><span class="o">().</span><span class="na">serviceDoneExecuting</span><span class="o">(</span>
                        <span class="n">data</span><span class="o">.</span><span class="na">token</span><span class="o">,</span> <span class="n">SERVICE_DONE_EXECUTING_ANON</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// nothing to do.
</span><span class="c1"></span>            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">mInstrumentation</span><span class="o">.</span><span class="na">onException</span><span class="o">(</span><span class="n">service</span><span class="o">,</span> <span class="n">e</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span>
                    <span class="s">&#34;Unable to create service &#34;</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">name</span>
                    <span class="o">+</span> <span class="s">&#34;: &#34;</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div><p><strong>handleCreateService做了如下事情</strong></p>
<ol>
<li>通过类加载器创建<code>Service</code>的实例</li>
<li>创建<code>Application</code>对象并调用其onCreate(), 当然<code>Application</code>创建过程只会有一次.</li>
<li>接着创建<code>ContextImpl</code>对象并通过<code>Service</code>的attach方法建立二者之间的关系, 这个过程和<code>Activity</code>实际上是类似的. 毕竟Service和Activity都是一个Context.</li>
<li>调用<code>onCreate()</code>并将Service对象存储到<code>ActivityThread</code>中的一个列表. 就是<code>final ArrayMap&lt;IBinder, Service&gt; mServices = new ArrayMap&lt;IBinder, Service&gt;();</code></li>
</ol>
<p><code>onCreate()</code>方法被执行了也就意味着<code>Service</code>已经启动了. 除此之外, <code>ActivityThread</code>中还会通过<code>handleServiceArgs()</code>方法调用Service的<code>onStartCommand()</code>方法.</p>
<h3 id="service的绑定过程">Service的绑定过程</h3>
<p>和启动过程一样, 绑定过程同样是从<code>ContextImpl</code>开始的. 先查看<code>bindServiceCommon()</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java">    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">bindServiceCommon</span><span class="o">(</span><span class="n">Intent</span> <span class="n">service</span><span class="o">,</span> <span class="n">ServiceConnection</span> <span class="n">conn</span><span class="o">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">,</span>
            <span class="n">UserHandle</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">IServiceConnection</span> <span class="n">sd</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">conn</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;connection is null&#34;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mPackageInfo</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">sd</span> <span class="o">=</span> <span class="n">mPackageInfo</span><span class="o">.</span><span class="na">getServiceDispatcher</span><span class="o">(</span><span class="n">conn</span><span class="o">,</span> <span class="n">getOuterContext</span><span class="o">(),</span>
                    <span class="n">mMainThread</span><span class="o">.</span><span class="na">getHandler</span><span class="o">(),</span> <span class="n">flags</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="s">&#34;Not supported in system context&#34;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">validateServiceIntent</span><span class="o">(</span><span class="n">service</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">IBinder</span> <span class="n">token</span> <span class="o">=</span> <span class="n">getActivityToken</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">token</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">flags</span><span class="o">&amp;</span><span class="n">BIND_AUTO_CREATE</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="n">mPackageInfo</span> <span class="o">!=</span> <span class="kc">null</span>
                    <span class="o">&amp;&amp;</span> <span class="n">mPackageInfo</span><span class="o">.</span><span class="na">getApplicationInfo</span><span class="o">().</span><span class="na">targetSdkVersion</span>
                    <span class="o">&lt;</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Build</span><span class="o">.</span><span class="na">VERSION_CODES</span><span class="o">.</span><span class="na">ICE_CREAM_SANDWICH</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">flags</span> <span class="o">|=</span> <span class="n">BIND_WAIVE_PRIORITY</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">service</span><span class="o">.</span><span class="na">prepareToLeaveProcess</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">ActivityManagerNative</span><span class="o">.</span><span class="na">getDefault</span><span class="o">().</span><span class="na">bindService</span><span class="o">(</span>
                <span class="n">mMainThread</span><span class="o">.</span><span class="na">getApplicationThread</span><span class="o">(),</span> <span class="n">getActivityToken</span><span class="o">(),</span>
                <span class="n">service</span><span class="o">,</span> <span class="n">service</span><span class="o">.</span><span class="na">resolveTypeIfNeeded</span><span class="o">(</span><span class="n">getContentResolver</span><span class="o">()),</span>
                <span class="n">sd</span><span class="o">,</span> <span class="n">flags</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getIdentifier</span><span class="o">());</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">SecurityException</span><span class="o">(</span>
                        <span class="s">&#34;Not allowed to bind to service &#34;</span> <span class="o">+</span> <span class="n">service</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">res</span> <span class="o">!=</span> <span class="n">0</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div><p>这段代码首先将客户端的<code>ServiceConnection</code>对象转化成为<code>ServiceDispatcher.InnerConnection</code>对象. 不能直接使用<code>ServiceConnection</code>对象必须借助于Binder才能让远程服务回调自己的方法. 而<code>ServiceDispatcher</code>的内部类<code>InnerConnection</code>刚好充当了Binder这个角色.</p>
<p><code>ServiceDispatcher</code>的作用就是连接<code>ServiceConnection</code>和<code>InnerConnection</code>的作用. 这个过程由<code>LoadedApk</code>的<code>getServiceDispatcher()</code>方法完成. 实现如下:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java">
<span class="kd">public</span> <span class="kd">final</span> <span class="n">IServiceConnection</span> <span class="nf">getServiceDispatcher</span><span class="o">(</span><span class="n">ServiceConnection</span> <span class="n">c</span><span class="o">,</span>
       <span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">Handler</span> <span class="n">handler</span><span class="o">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">)</span> <span class="o">{</span>
   <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mServices</span><span class="o">)</span> <span class="o">{</span>
       <span class="n">LoadedApk</span><span class="o">.</span><span class="na">ServiceDispatcher</span> <span class="n">sd</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
       <span class="n">ArrayMap</span><span class="o">&lt;</span><span class="n">ServiceConnection</span><span class="o">,</span> <span class="n">LoadedApk</span><span class="o">.</span><span class="na">ServiceDispatcher</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="n">mServices</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
       <span class="k">if</span> <span class="o">(</span><span class="n">map</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
           <span class="n">sd</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
       <span class="o">}</span>
       <span class="k">if</span> <span class="o">(</span><span class="n">sd</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
           <span class="n">sd</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServiceDispatcher</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="n">context</span><span class="o">,</span> <span class="n">handler</span><span class="o">,</span> <span class="n">flags</span><span class="o">);</span>
           <span class="k">if</span> <span class="o">(</span><span class="n">map</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
               <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayMap</span><span class="o">&lt;</span><span class="n">ServiceConnection</span><span class="o">,</span> <span class="n">LoadedApk</span><span class="o">.</span><span class="na">ServiceDispatcher</span><span class="o">&gt;();</span>
               <span class="n">mServices</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">map</span><span class="o">);</span>
           <span class="o">}</span>
           <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="n">sd</span><span class="o">);</span>
       <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
           <span class="n">sd</span><span class="o">.</span><span class="na">validate</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">handler</span><span class="o">);</span>
       <span class="o">}</span>
       <span class="k">return</span> <span class="n">sd</span><span class="o">.</span><span class="na">getIServiceConnection</span><span class="o">();</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p><code>mService</code>是一个<code>ArrayMap</code>, 它存储了一个应用当前活动的<code>ServiceConnection</code>和<code>ServiceDispatcher</code>的映射关系.</p>
<p>系统首先会查找是否存在相同的<code>ServiceConnection</code>, 如果不存在就会重新创建一个<code>ServiceDispatch</code>对象并将其存储在<code>mService</code>中, 其中的key是<code>ServiceConnection</code>,value是<code>ServiceDispatcher</code>, 在<code>ServiceDispatcher</code>的内部又保存了<code>ServiceConnection</code>和<code>InnerConnection</code>对象. 当<code>Service</code>和客户端建立连接后, 系统会通过InnerConnection来调用<code>ServiceConnection</code>中的<code>onServiceConnected()</code>方法. 这个过程可能是跨进程的. 当<code>ServiceDispatcher</code>创建好了以后, <code>getServiceDispatcher</code>会返回其保存的<code>InnerConnection</code>对象.</p>
<p>接着<code>bindServiceCommon</code>方法会通过AMS完成Service的具体绑定, 这对应着<code>AMS#bindService()</code>方法.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java">    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">bindService</span><span class="o">(</span><span class="n">IApplicationThread</span> <span class="n">caller</span><span class="o">,</span> <span class="n">IBinder</span> <span class="n">token</span><span class="o">,</span>
            <span class="n">Intent</span> <span class="n">service</span><span class="o">,</span> <span class="n">String</span> <span class="n">resolvedType</span><span class="o">,</span>
            <span class="n">IServiceConnection</span> <span class="n">connection</span><span class="o">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">,</span> <span class="kt">int</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">enforceNotIsolatedCaller</span><span class="o">(</span><span class="s">&#34;bindService&#34;</span><span class="o">);</span>

        <span class="c1">// Refuse possible leaked file descriptors
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">service</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">service</span><span class="o">.</span><span class="na">hasFileDescriptors</span><span class="o">()</span> <span class="o">==</span> <span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;File descriptors passed in Intent&#34;</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">synchronized</span><span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">mServices</span><span class="o">.</span><span class="na">bindServiceLocked</span><span class="o">(</span><span class="n">caller</span><span class="o">,</span> <span class="n">token</span><span class="o">,</span> <span class="n">service</span><span class="o">,</span> <span class="n">resolvedType</span><span class="o">,</span>
                    <span class="n">connection</span><span class="o">,</span> <span class="n">flags</span><span class="o">,</span> <span class="n">userId</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div><p>然后<code>AMS</code>会调用<code>ActivityService#bindServiceLocked()</code>方法. 然后调用<code>bringUpServiceLocked()</code>, 继续调用.  发现调到了<code>realStartServiceLocked</code>. 这里面的逻辑和<strong>启动过程</strong>类似. 最终都是通过<code>ApplicationThread</code>来完成<code>Service</code>实例的创建并执行其onCreate()方法. 这里不再重复说明.</p>
<p><strong>与Service启动稍微不同的是</strong>:</p>
<ul>
<li>绑定过程: 会调用到<code>app.thread(ActivityThread)</code>的<code>scheduleBindService()</code>方法. 而这个过程的实现是在<code>ActiveService#requestServiceBindingLocked()</code>方法.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">requestServiceBindingLocked</span><span class="o">(</span><span class="n">ServiceRecord</span> <span class="n">r</span><span class="o">,</span>
            <span class="n">IntentBindRecord</span> <span class="n">i</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">execInFg</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">rebind</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">app</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">r</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">thread</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// If service is not currently running, can&#39;t yet bind.
</span><span class="c1"></span>            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">((!</span><span class="n">i</span><span class="o">.</span><span class="na">requested</span> <span class="o">||</span> <span class="n">rebind</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">.</span><span class="na">apps</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">bumpServiceExecutingLocked</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">execInFg</span><span class="o">,</span> <span class="s">&#34;bind&#34;</span><span class="o">);</span>
                <span class="n">r</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">forceProcessStateUpTo</span><span class="o">(</span><span class="n">ActivityManager</span><span class="o">.</span><span class="na">PROCESS_STATE_SERVICE</span><span class="o">);</span>
                <span class="n">r</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">thread</span><span class="o">.</span><span class="na">scheduleBindService</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">i</span><span class="o">.</span><span class="na">intent</span><span class="o">.</span><span class="na">getIntent</span><span class="o">(),</span> <span class="n">rebind</span><span class="o">,</span>
                        <span class="n">r</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">repProcState</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">rebind</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">i</span><span class="o">.</span><span class="na">requested</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="n">i</span><span class="o">.</span><span class="na">hasBound</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                <span class="n">i</span><span class="o">.</span><span class="na">doRebind</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG_SERVICE</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Crashed while binding &#34;</span> <span class="o">+</span> <span class="n">r</span><span class="o">);</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div><p><code>app.thread</code>实际上就是<code>ApplicationThread</code>. <code>ApplicationThread</code>的一系列以<code>schedule</code>开头的方法, 其内部都是通过Handler H来中转的.</p>
<p><strong>H的内部</strong> 接收到<code>BIND_SERVICE</code>消息需要处理时, 会交给<code>ActivityThread#handleBindService()</code>. 在<code>handlerBindService</code>中, 首先根据<code>Service</code>的token取出<code>Service</code>对象. 然后调用<code>Service#onBind()</code>方法, Service的onBinder方法返回一个Binder对象给客户端使用. 原则上来说, <code>Service#onBind()</code>方法被调用后, <code>Service</code>就处于绑定状态, 但是<code>onBind</code>方法是<code>Service</code>的方法, 这个时候客户端并不知道已经成功连接<code>Service</code>, 所以还必须调用客户端的<code>ServiceConnection</code>中的<code>onServiceConnected()</code>, 这个过程是由<code>AMS#publishService()</code>来完成.</p>
<p><code>handleBindService()</code>实现如下:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">handleBindService</span><span class="o">(</span><span class="n">BindServiceData</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Service</span> <span class="n">s</span> <span class="o">=</span> <span class="n">mServices</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">token</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG_SERVICE</span><span class="o">)</span>
            <span class="n">Slog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;handleBindService s=&#34;</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> <span class="s">&#34; rebind=&#34;</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="na">rebind</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">data</span><span class="o">.</span><span class="na">intent</span><span class="o">.</span><span class="na">setExtrasClassLoader</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">());</span>
                <span class="n">data</span><span class="o">.</span><span class="na">intent</span><span class="o">.</span><span class="na">prepareToEnterProcess</span><span class="o">();</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">data</span><span class="o">.</span><span class="na">rebind</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">IBinder</span> <span class="n">binder</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">onBind</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">intent</span><span class="o">);</span>
                        <span class="c1">// 看我看我
</span><span class="c1"></span>                        <span class="n">ActivityManagerNative</span><span class="o">.</span><span class="na">getDefault</span><span class="o">().</span><span class="na">publishService</span><span class="o">(</span>
                                <span class="n">data</span><span class="o">.</span><span class="na">token</span><span class="o">,</span> <span class="n">data</span><span class="o">.</span><span class="na">intent</span><span class="o">,</span> <span class="n">binder</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="n">s</span><span class="o">.</span><span class="na">onRebind</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">intent</span><span class="o">);</span>
                        <span class="n">ActivityManagerNative</span><span class="o">.</span><span class="na">getDefault</span><span class="o">().</span><span class="na">serviceDoneExecuting</span><span class="o">(</span>
                                <span class="n">data</span><span class="o">.</span><span class="na">token</span><span class="o">,</span> <span class="n">SERVICE_DONE_EXECUTING_ANON</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="n">ensureJitEnabled</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">mInstrumentation</span><span class="o">.</span><span class="na">onException</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="n">e</span><span class="o">))</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span>
                            <span class="s">&#34;Unable to bind to service &#34;</span> <span class="o">+</span> <span class="n">s</span>
                            <span class="o">+</span> <span class="s">&#34; with &#34;</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="na">intent</span> <span class="o">+</span> <span class="s">&#34;: &#34;</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div><p>还记得多次绑定会有什么效果么?  <code>Service#onBind()</code>方法只会执行一次, 除非Service被终止了. 当Service的<code>onBind()</code>执行之后, 系统还需要告知客户端已经成功连接Service了. 这些过程是在<code>AMS#publishService()</code>实现.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java">
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">publishService</span><span class="o">(</span><span class="n">IBinder</span> <span class="n">token</span><span class="o">,</span> <span class="n">Intent</span> <span class="n">intent</span><span class="o">,</span> <span class="n">IBinder</span> <span class="n">service</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Refuse possible leaked file descriptors
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">intent</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">intent</span><span class="o">.</span><span class="na">hasFileDescriptors</span><span class="o">()</span> <span class="o">==</span> <span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;File descriptors passed in Intent&#34;</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">synchronized</span><span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!(</span><span class="n">token</span> <span class="k">instanceof</span> <span class="n">ServiceRecord</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;Invalid service token&#34;</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">mServices</span><span class="o">.</span><span class="na">publishServiceLocked</span><span class="o">((</span><span class="n">ServiceRecord</span><span class="o">)</span><span class="n">token</span><span class="o">,</span> <span class="n">intent</span><span class="o">,</span> <span class="n">service</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div><p>可以看到这里将具体的工作交给了<code>mServices.publishServiceLocked()</code>它是一个<code>ActiveService</code>类型. 其核心代码就是:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"> <span class="n">c</span><span class="o">.</span><span class="na">conn</span><span class="o">.</span><span class="na">connected</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">name</span><span class="o">,</span> <span class="n">service</span><span class="o">);</span>
 <span class="c1">//c的类型是ConnectionRecord
</span><span class="c1"></span> <span class="c1">//c.conn的类型是ServiceDispatcher.InnerConnection
</span><span class="c1"></span> <span class="c1">//service参数就是Service的onBind返回的Binder对象
</span></code></pre></div><p>而<code>InnerConnection#connected()</code>方法内又调用<code>ServiceDispatcher的connected()</code>内部就是创建一个<code>RunConnection()</code>发送到<code>mActivityThread</code>的消息中.</p>
<p>对于<code>Service</code>的绑定过程来说, <code>ServiceDispatcher</code>的<code>mActivityThread</code>是一个Handler, 就是<code>ActivityThread#H</code>, 从前面的<code>ServiceDispatcher</code>的创建过程来说, <code>mActivityThread</code>不会为null, 所以<code>RunConnection</code>就可以经由<code>H</code>的post方法从而运行在主线程. 因此客户端的<code>ServiceConnection</code>中的方法是在主线程被回调的.</p>
<p><strong>RunConnection</strong>是一个<code>Runnable</code>接口, <code>run()</code>方法也是简单调用<code>ServiceDispatcher#doConnected方法</code>, 由于<code>ServiceDispatcher</code>内部保存了客户端的<code>ServiceConnection</code>对象, 因此他可以很方便调用<code>ServiceConnection</code>对象的<code>onServiceConnected()</code></p>
<hr>
<p>解绑和停止过程, 基本类似&hellip; 恩 书上这么说的.</p>
<h2 id="broadcastreceiver的工作流程">BroadcastReceiver的工作流程</h2>
<p>简单回顾一下广播的使用方法, 首先定义广播接收者, 只需要继承<code>BroadcastReceiver</code>并重写<code>onReceive()</code>方法即可. 定义好了广播接收者, 还需要注册广播接收者, 分为两种静态注册或者动态注册. 注册完成之后就可以发送广播了.</p>
<h3 id="广播的注册过程">广播的注册过程</h3>
<p>广播的注册有两种<strong>静态注册</strong>, <strong>动态注册</strong>. 其中<strong>静态注册</strong>的广播在应用安装时由系统自动完成注册, 具体来说是有<strong>PMS</strong>(PackageManagerService)来完成整个注册过程的. 除了广播外, 其他三大组件也都是在应用安装时由<code>PMS</code>解析并注册的.</p>
<p><strong>动态注册</strong>的过程是从<code>ContextWrapper#registerReceiver()</code>开始的. 和<code>Activity</code>或者<code>Service</code>一样. <code>ContextWrapper</code>并没有做实际的工作, 而是将注册的过程直接交给了<code>ContextImpl</code>来完成.</p>
<p><code>ContextImpl#registerReceiver()</code>方法调用了本类的<code>registerReceiverInternal()</code>方法.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java">    <span class="kd">private</span> <span class="n">Intent</span> <span class="nf">registerReceiverInternal</span><span class="o">(</span><span class="n">BroadcastReceiver</span> <span class="n">receiver</span><span class="o">,</span> <span class="kt">int</span> <span class="n">userId</span><span class="o">,</span>
            <span class="n">IntentFilter</span> <span class="n">filter</span><span class="o">,</span> <span class="n">String</span> <span class="n">broadcastPermission</span><span class="o">,</span>
            <span class="n">Handler</span> <span class="n">scheduler</span><span class="o">,</span> <span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">IIntentReceiver</span> <span class="n">rd</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">receiver</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mPackageInfo</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">context</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">scheduler</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">scheduler</span> <span class="o">=</span> <span class="n">mMainThread</span><span class="o">.</span><span class="na">getHandler</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="n">rd</span> <span class="o">=</span> <span class="n">mPackageInfo</span><span class="o">.</span><span class="na">getReceiverDispatcher</span><span class="o">(</span>
                    <span class="n">receiver</span><span class="o">,</span> <span class="n">context</span><span class="o">,</span> <span class="n">scheduler</span><span class="o">,</span>
                    <span class="n">mMainThread</span><span class="o">.</span><span class="na">getInstrumentation</span><span class="o">(),</span> <span class="kc">true</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">scheduler</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">scheduler</span> <span class="o">=</span> <span class="n">mMainThread</span><span class="o">.</span><span class="na">getHandler</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="n">rd</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LoadedApk</span><span class="o">.</span><span class="na">ReceiverDispatcher</span><span class="o">(</span>
                        <span class="n">receiver</span><span class="o">,</span> <span class="n">context</span><span class="o">,</span> <span class="n">scheduler</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">true</span><span class="o">).</span><span class="na">getIIntentReceiver</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">ActivityManagerNative</span><span class="o">.</span><span class="na">getDefault</span><span class="o">().</span><span class="na">registerReceiver</span><span class="o">(</span>
                    <span class="n">mMainThread</span><span class="o">.</span><span class="na">getApplicationThread</span><span class="o">(),</span> <span class="n">mBasePackageName</span><span class="o">,</span>
                    <span class="n">rd</span><span class="o">,</span> <span class="n">filter</span><span class="o">,</span> <span class="n">broadcastPermission</span><span class="o">,</span> <span class="n">userId</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div><p>上述代码中, 系统首先从<code>mPackageInfo</code>获取到<code>IIntentReceiver</code>对象, 然后再采用跨进程的方式向AMS发送广播注册的请求. 之所以采用<code>IIntentReceiver</code>而不是直接采用<code>BroadcastReceiver</code>, 这是因为上述注册过程中是一个进程间通信的过程. 而<code>BroadcastReceiver</code>作为Android中的一个组件是不能直接跨进程传递的. 所有需要通过<code>IIntentReceiver</code>来中转一下.</p>
<p><code>IIntentReceiver</code>作为一个<code>Binder</code>接口, 它的具体实现是<code>LoadedApk.ReceiverDispatcher.InnerReceiver</code>, <code>ReceiverDispatcher</code>的内部同时保存了<code>BroadcastReceiver</code>和<code>InnerReceiver</code>, 这样当接收到广播的时候, <code>ReceiverDispatcher</code>可以很方便的调用<code>BroadcastReceiver#onReceive()</code>方法.  这里和Service很像有同样的类, 并且内部类中同样也是一个Binder接口.</p>
<p>看一下<code>LoadedApk.ReceiverDispatcher#getIIntentReceiver()</code>的实现, 很显然<code>getReceiverDispatcher()</code>重新创建了一个<code>ReceiverDispatcher</code>对象并将其保存的<code>InnerReceiver</code>对象作为返回值返回, 其中<code>InnerReceiver</code>对象和<code>BroadcastReceiver</code>都是在<code>ReceiverDispatcher</code>的构造方法中被保存起来的.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java">    <span class="kd">public</span> <span class="n">IIntentReceiver</span> <span class="nf">getReceiverDispatcher</span><span class="o">(</span><span class="n">BroadcastReceiver</span> <span class="n">r</span><span class="o">,</span>
            <span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">Handler</span> <span class="n">handler</span><span class="o">,</span>
            <span class="n">Instrumentation</span> <span class="n">instrumentation</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">registered</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mReceivers</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">LoadedApk</span><span class="o">.</span><span class="na">ReceiverDispatcher</span> <span class="n">rd</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="n">ArrayMap</span><span class="o">&lt;</span><span class="n">BroadcastReceiver</span><span class="o">,</span> <span class="n">LoadedApk</span><span class="o">.</span><span class="na">ReceiverDispatcher</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">registered</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">map</span> <span class="o">=</span> <span class="n">mReceivers</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">map</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">rd</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">rd</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">rd</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReceiverDispatcher</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">context</span><span class="o">,</span> <span class="n">handler</span><span class="o">,</span>
                        <span class="n">instrumentation</span><span class="o">,</span> <span class="n">registered</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">registered</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">map</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayMap</span><span class="o">&lt;</span><span class="n">BroadcastReceiver</span><span class="o">,</span> <span class="n">LoadedApk</span><span class="o">.</span><span class="na">ReceiverDispatcher</span><span class="o">&gt;();</span>
                        <span class="n">mReceivers</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">map</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">rd</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">rd</span><span class="o">.</span><span class="na">validate</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">handler</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">rd</span><span class="o">.</span><span class="na">mForgotten</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="k">return</span> <span class="n">rd</span><span class="o">.</span><span class="na">getIIntentReceiver</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div><p>由于注册广播真正实现过程是在<code>AMS</code>中, 因此跟进AMS中, 首先看<code>registerReceiver()</code>方法, 这里只关心里面的核心部分. 这段代码最终会把远程的<strong>InnerReceiver</strong>对象以及<strong>IntentFilter</strong>对象存储起来, 这样整个广播的注册就完成了.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">Intent</span> <span class="nf">registerReceiver</span><span class="o">(</span><span class="n">IApplicationThread</span> <span class="n">caller</span><span class="o">,</span> <span class="n">String</span> <span class="n">callerPackage</span><span class="o">,</span>
       <span class="n">IIntentReceiver</span> <span class="n">receiver</span><span class="o">,</span> <span class="n">IntentFilter</span> <span class="n">filter</span><span class="o">,</span> <span class="n">String</span> <span class="n">permission</span><span class="o">,</span> <span class="kt">int</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//...
</span><span class="c1"></span>    <span class="n">mRegisteredReceivers</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">receiver</span><span class="o">.</span><span class="na">asBinder</span><span class="o">(),</span> <span class="n">rl</span><span class="o">);</span>
    <span class="n">BroadcastFilter</span> <span class="n">bf</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BroadcastFilter</span><span class="o">(</span><span class="n">filter</span><span class="o">,</span> <span class="n">rl</span><span class="o">,</span> <span class="n">callerPackage</span><span class="o">,</span><span class="n">permission</span><span class="o">,</span> <span class="n">callingUid</span><span class="o">,</span> <span class="n">userId</span><span class="o">);</span>
    <span class="n">rl</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">bf</span><span class="o">);</span>
   
    <span class="n">mReceiverResolver</span><span class="o">.</span><span class="na">addFilter</span><span class="o">(</span><span class="n">bf</span><span class="o">);</span>  
<span class="o">}</span>
</code></pre></div><h3 id="广播的发送和接收过程">广播的发送和接收过程</h3>
<p>当通过<code>send()</code>发送广播时, AMS会查找出匹配的广播接收者并将广播发送给他们处理. 广播的发送种类有: <strong>普通广播</strong>, <strong>有序广播</strong>, <strong>粘性广播</strong>.  这里分析普通广播.</p>
<p>广播的发送和接收, 本质就是一个过程的两个阶段. 广播的发送仍然开始于<code>ContextImpl#sendBroadcase()</code>方法, 之所以不是<code>Context</code>, 那是因为<code>Context#sendBroad()</code>是一个抽象方法. 和广播的注册过程一样, <code>ContextWrapper#sendBroadcast()</code>仍然什么都不做, 只是把事情交给了<code>ContextImpl</code>去处理, <code>ContextImpl#sendBroadcast()</code>源码如下</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendBroadcast</span><span class="o">(</span><span class="n">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
   <span class="n">warnIfCallingFromSystemProcess</span><span class="o">();</span>
   <span class="n">String</span> <span class="n">resolvedType</span> <span class="o">=</span> <span class="n">intent</span><span class="o">.</span><span class="na">resolveTypeIfNeeded</span><span class="o">(</span><span class="n">getContentResolver</span><span class="o">());</span>
  
   <span class="n">intent</span><span class="o">.</span><span class="na">prepareToLeaveProcess</span><span class="o">();</span>
   <span class="n">ActivityManagerNative</span><span class="o">.</span><span class="na">getDefault</span><span class="o">().</span><span class="na">broadcastIntent</span><span class="o">(</span>
          <span class="n">mMainThread</span><span class="o">.</span><span class="na">getApplicationThread</span><span class="o">(),</span> <span class="n">intent</span><span class="o">,</span> <span class="n">resolvedType</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span>
          <span class="n">Activity</span><span class="o">.</span><span class="na">RESULT_OK</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">AppOpsManager</span><span class="o">.</span><span class="na">OP_NONE</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span>
          <span class="n">getUserId</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></div><p>看到<code>ContextImpl</code>里面也几乎什么都没有做, 内部直接向<code>AMS</code>发起了一个异步请求用于发送广播. 接下来看<code>AMS#broadcastIntent()</code>方法.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">broadcastIntent</span><span class="o">(</span><span class="n">IApplicationThread</span> <span class="n">caller</span><span class="o">,</span>
       <span class="n">Intent</span> <span class="n">intent</span><span class="o">,</span> <span class="n">String</span> <span class="n">resolvedType</span><span class="o">,</span> <span class="n">IIntentReceiver</span> <span class="n">resultTo</span><span class="o">,</span>
       <span class="kt">int</span> <span class="n">resultCode</span><span class="o">,</span> <span class="n">String</span> <span class="n">resultData</span><span class="o">,</span> <span class="n">Bundle</span> <span class="n">resultExtras</span><span class="o">,</span>
       <span class="n">String</span><span class="o">[]</span> <span class="n">requiredPermissions</span><span class="o">,</span> <span class="kt">int</span> <span class="n">appOp</span><span class="o">,</span> <span class="n">Bundle</span> <span class="n">options</span><span class="o">,</span>
       <span class="kt">boolean</span> <span class="n">serialized</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">sticky</span><span class="o">,</span> <span class="kt">int</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
   <span class="n">enforceNotIsolatedCaller</span><span class="o">(</span><span class="s">&#34;broadcastIntent&#34;</span><span class="o">);</span>
   <span class="kd">synchronized</span><span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
       <span class="n">intent</span> <span class="o">=</span> <span class="n">verifyBroadcastLocked</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>

       <span class="kd">final</span> <span class="n">ProcessRecord</span> <span class="n">callerApp</span> <span class="o">=</span> <span class="n">getRecordForAppLocked</span><span class="o">(</span><span class="n">caller</span><span class="o">);</span>
       <span class="kd">final</span> <span class="kt">int</span> <span class="n">callingPid</span> <span class="o">=</span> <span class="n">Binder</span><span class="o">.</span><span class="na">getCallingPid</span><span class="o">();</span>
       <span class="kd">final</span> <span class="kt">int</span> <span class="n">callingUid</span> <span class="o">=</span> <span class="n">Binder</span><span class="o">.</span><span class="na">getCallingUid</span><span class="o">();</span>
       <span class="kd">final</span> <span class="kt">long</span> <span class="n">origId</span> <span class="o">=</span> <span class="n">Binder</span><span class="o">.</span><span class="na">clearCallingIdentity</span><span class="o">();</span>
       <span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">broadcastIntentLocked</span><span class="o">(</span><span class="n">callerApp</span><span class="o">,</span>
               <span class="n">callerApp</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">callerApp</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">packageName</span> <span class="o">:</span> <span class="kc">null</span><span class="o">,</span>
               <span class="n">intent</span><span class="o">,</span> <span class="n">resolvedType</span><span class="o">,</span> <span class="n">resultTo</span><span class="o">,</span> <span class="n">resultCode</span><span class="o">,</span> <span class="n">resultData</span><span class="o">,</span> <span class="n">resultExtras</span><span class="o">,</span>
               <span class="n">requiredPermissions</span><span class="o">,</span> <span class="n">appOp</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">serialized</span><span class="o">,</span> <span class="n">sticky</span><span class="o">,</span>
               <span class="n">callingPid</span><span class="o">,</span> <span class="n">callingUid</span><span class="o">,</span> <span class="n">userId</span><span class="o">);</span>
       <span class="n">Binder</span><span class="o">.</span><span class="na">restoreCallingIdentity</span><span class="o">(</span><span class="n">origId</span><span class="o">);</span>
       <span class="k">return</span> <span class="n">res</span><span class="o">;</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>看到这里, 又继续调用<code>broadcastIntentLocked()</code>方法, 这个方法有点长. 在代码开始处</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="c1">// By default broadcasts do not go to stopped apps.
</span><span class="c1"></span><span class="n">intent</span><span class="o">.</span><span class="na">addFlags</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">FLAG_EXCLUDE_STOPPED_PACKAGES</span><span class="o">);</span>
</code></pre></div><p>这个表示默认情况下广播不会发送给已经停止的应用, android5.0中.  而android 3.1开始就增添了两个标记为. 分别是<code>FLAG_INCLUDE_STOPPED_PACKAGES</code>, <code>FLAG_EXCLUDE_STOPPED_PACKAGES</code>. 用来控制广播是否要对处于停止的应用起作用.</p>
<ul>
<li><code>FLAG_INCLUDE_STOPPED_PACKAGES</code>: 包含停止应用, 广播会发送给已停止的应用.</li>
<li><code>FLAG_EXCLUDE_STOPPED_PACKAGES</code>: 不包含已停止应用, 广播不会发送给已停止的应用</li>
</ul>
<p>在<strong>android 3.1</strong>开始, 系统就为所有广播默认添加了<code>FLAG_EXCLUDE_STOPPED_PACKAGES</code>标识, <strong>为了防止广播无意间或者不必要的时候调起已经停止运行的应用</strong>. 当这两个标记共存的时候以<code>FLAG_INCLUDE_STOPPED_PACKAGES</code>(非默认项为主).</p>
<hr>
<p>应用处于停止分为两种</p>
<ol>
<li>应用安装后未运行</li>
<li>被手动或者其他应用强停</li>
</ol>
<p>开机广播同样受到了这个标志位的影响. 从Android 3.1开始处于停止状态的应用同样无法接受到开机广播, 而在<code>android 3.1</code>之前处于停止的状态也是可以接收到的开机广播的.</p>
<p>在<code>broadcastIntentLocked()</code>内部, 会根据intent-filter查找出匹配的广播接收者并经过一系列的条件过滤. 最终会将满足条件的广播接收者添加到<code>BroadcastQueue</code>中, 接着<code>BroadcastQueue</code>就会将广播发送给相应广播接收者.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java">
<span class="k">if</span> <span class="o">((</span><span class="n">receivers</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">receivers</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span>
      <span class="o">||</span> <span class="n">resultTo</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">BroadcastQueue</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">broadcastQueueForIntent</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
  <span class="n">BroadcastRecord</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BroadcastRecord</span><span class="o">(</span><span class="n">queue</span><span class="o">,</span> <span class="n">intent</span><span class="o">,</span> <span class="n">callerApp</span><span class="o">,</span>
          <span class="n">callerPackage</span><span class="o">,</span> <span class="n">callingPid</span><span class="o">,</span> <span class="n">callingUid</span><span class="o">,</span> <span class="n">resolvedType</span><span class="o">,</span>
          <span class="n">requiredPermissions</span><span class="o">,</span> <span class="n">appOp</span><span class="o">,</span> <span class="n">brOptions</span><span class="o">,</span> <span class="n">receivers</span><span class="o">,</span> <span class="n">resultTo</span><span class="o">,</span> <span class="n">resultCode</span><span class="o">,</span>
          <span class="n">resultData</span><span class="o">,</span> <span class="n">resultExtras</span><span class="o">,</span> <span class="n">ordered</span><span class="o">,</span> <span class="n">sticky</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">userId</span><span class="o">);</span>

  <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG_BROADCAST</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="n">TAG_BROADCAST</span><span class="o">,</span> <span class="s">&#34;Enqueueing ordered broadcast &#34;</span> <span class="o">+</span> <span class="n">r</span>
          <span class="o">+</span> <span class="s">&#34;: prev had &#34;</span> <span class="o">+</span> <span class="n">queue</span><span class="o">.</span><span class="na">mOrderedBroadcasts</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG_BROADCAST</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG_BROADCAST</span><span class="o">,</span>
          <span class="s">&#34;Enqueueing broadcast &#34;</span> <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="na">intent</span><span class="o">.</span><span class="na">getAction</span><span class="o">());</span>

  <span class="kt">boolean</span> <span class="n">replaced</span> <span class="o">=</span> <span class="n">replacePending</span> <span class="o">&amp;&amp;</span> <span class="n">queue</span><span class="o">.</span><span class="na">replaceOrderedBroadcastLocked</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(!</span><span class="n">replaced</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">queue</span><span class="o">.</span><span class="na">enqueueOrderedBroadcastLocked</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
      <span class="n">queue</span><span class="o">.</span><span class="na">scheduleBroadcastsLocked</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>跟进<code>BroadcastQueue#scheduleBroadcastsLocked()</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">scheduleBroadcastsLocked</span><span class="o">()</span> <span class="o">{</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG_BROADCAST</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="n">TAG_BROADCAST</span><span class="o">,</span> <span class="s">&#34;Schedule broadcasts [&#34;</span>
           <span class="o">+</span> <span class="n">mQueueName</span> <span class="o">+</span> <span class="s">&#34;]: current=&#34;</span>
           <span class="o">+</span> <span class="n">mBroadcastsScheduled</span><span class="o">);</span>

   <span class="k">if</span> <span class="o">(</span><span class="n">mBroadcastsScheduled</span><span class="o">)</span> <span class="o">{</span>
       <span class="k">return</span><span class="o">;</span>
   <span class="o">}</span>
   <span class="n">mHandler</span><span class="o">.</span><span class="na">sendMessage</span><span class="o">(</span><span class="n">mHandler</span><span class="o">.</span><span class="na">obtainMessage</span><span class="o">(</span><span class="n">BROADCAST_INTENT_MSG</span><span class="o">,</span> <span class="k">this</span><span class="o">));</span>
   <span class="n">mBroadcastsScheduled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><p>方法内并没有立即发送广播, 而是发送了一个<code>BROADCAST_INTENT_MSG</code>类型的消息, <code>BroadcastQueue</code>收到消息后会调用<code>processNextBroadcast()</code>方法. 这个方法对普通广播的处理如下:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java">
<span class="c1">// First, deliver any non-serialized broadcasts right away.
</span><span class="c1"></span>  <span class="k">while</span> <span class="o">(</span><span class="n">mParallelBroadcasts</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">r</span> <span class="o">=</span> <span class="n">mParallelBroadcasts</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
      <span class="n">r</span><span class="o">.</span><span class="na">dispatchTime</span> <span class="o">=</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">();</span>
      <span class="n">r</span><span class="o">.</span><span class="na">dispatchClockTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
      <span class="kd">final</span> <span class="kt">int</span> <span class="n">N</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">receivers</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG_BROADCAST_LIGHT</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="n">TAG_BROADCAST</span><span class="o">,</span> <span class="s">&#34;Processing parallel broadcast [&#34;</span>
              <span class="o">+</span> <span class="n">mQueueName</span> <span class="o">+</span> <span class="s">&#34;] &#34;</span> <span class="o">+</span> <span class="n">r</span><span class="o">);</span>
      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="n">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
          <span class="n">Object</span> <span class="n">target</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">receivers</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG_BROADCAST</span><span class="o">)</span>  <span class="n">Slog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="n">TAG_BROADCAST</span><span class="o">,</span>
                  <span class="s">&#34;Delivering non-ordered on [&#34;</span> <span class="o">+</span> <span class="n">mQueueName</span> <span class="o">+</span> <span class="s">&#34;] to registered &#34;</span>
                  <span class="o">+</span> <span class="n">target</span> <span class="o">+</span> <span class="s">&#34;: &#34;</span> <span class="o">+</span> <span class="n">r</span><span class="o">);</span>
          <span class="n">deliverToRegisteredReceiverLocked</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="o">(</span><span class="n">BroadcastFilter</span><span class="o">)</span><span class="n">target</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">addBroadcastToHistoryLocked</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG_BROADCAST_LIGHT</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="n">TAG_BROADCAST</span><span class="o">,</span> <span class="s">&#34;Done with parallel broadcast [&#34;</span>
              <span class="o">+</span> <span class="n">mQueueName</span> <span class="o">+</span> <span class="s">&#34;] &#34;</span> <span class="o">+</span> <span class="n">r</span><span class="o">);</span>
  <span class="o">}</span>       
</code></pre></div><p>无序广播存储在<code>mParallelBroadcasts</code>中, 系统会遍历这个集合并将其中的广播发送给他们所有的接收者, 具体的发送过程是通过<code>deliverToRegisteredReceiverLocked()</code>方法实现. <code>deliverToRegisteredReceiverLocked()</code>负责将一个广播发送给一个特定的接收者, 它的内部调用了<code>performReceiverLocked</code>方法来完成具体发送过程.</p>
<p><code>performReceiverLocked()</code>方法实现如下, 由于接收广播会调起应用程序, 因为<code>app.thread</code>不为null, 根据前面的总结<code>app.thread</code>仍然指<code>ApplicationThread</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">performReceiveLocked</span><span class="o">(</span><span class="n">ProcessRecord</span> <span class="n">app</span><span class="o">,</span> <span class="n">IIntentReceiver</span> <span class="n">receiver</span><span class="o">,</span>
            <span class="n">Intent</span> <span class="n">intent</span><span class="o">,</span> <span class="kt">int</span> <span class="n">resultCode</span><span class="o">,</span> <span class="n">String</span> <span class="n">data</span><span class="o">,</span> <span class="n">Bundle</span> <span class="n">extras</span><span class="o">,</span>
            <span class="kt">boolean</span> <span class="n">ordered</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">sticky</span><span class="o">,</span> <span class="kt">int</span> <span class="n">sendingUser</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RemoteException</span> <span class="o">{</span>
        <span class="c1">// Send the intent to the receiver asynchronously using one-way binder calls.
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">app</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">app</span><span class="o">.</span><span class="na">thread</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// If we have an app thread, do the call through that so it is
</span><span class="c1"></span>                <span class="c1">// correctly ordered with other one-way calls.
</span><span class="c1"></span>                <span class="n">app</span><span class="o">.</span><span class="na">thread</span><span class="o">.</span><span class="na">scheduleRegisteredReceiver</span><span class="o">(</span><span class="n">receiver</span><span class="o">,</span> <span class="n">intent</span><span class="o">,</span> <span class="n">resultCode</span><span class="o">,</span>
                        <span class="n">data</span><span class="o">,</span> <span class="n">extras</span><span class="o">,</span> <span class="n">ordered</span><span class="o">,</span> <span class="n">sticky</span><span class="o">,</span> <span class="n">sendingUser</span><span class="o">,</span> <span class="n">app</span><span class="o">.</span><span class="na">repProcState</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="c1">// Application has died. Receiver doesn&#39;t exist.
</span><span class="c1"></span>                <span class="k">throw</span> <span class="k">new</span> <span class="n">RemoteException</span><span class="o">(</span><span class="s">&#34;app.thread must not be null&#34;</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">receiver</span><span class="o">.</span><span class="na">performReceive</span><span class="o">(</span><span class="n">intent</span><span class="o">,</span> <span class="n">resultCode</span><span class="o">,</span> <span class="n">data</span><span class="o">,</span> <span class="n">extras</span><span class="o">,</span> <span class="n">ordered</span><span class="o">,</span>
                    <span class="n">sticky</span><span class="o">,</span> <span class="n">sendingUser</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div><p>而调用的<code>ApplicationThread#scheduleRegisteredReceiver()</code>实现比较简单, 它通过<code>InnerReceiver</code>来实现广播的接收</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java">   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">scheduleRegisteredReceiver</span><span class="o">(</span><span class="n">IIntentReceiver</span> <span class="n">receiver</span><span class="o">,</span> <span class="n">Intent</span> <span class="n">intent</span><span class="o">,</span>
           <span class="kt">int</span> <span class="n">resultCode</span><span class="o">,</span> <span class="n">String</span> <span class="n">dataStr</span><span class="o">,</span> <span class="n">Bundle</span> <span class="n">extras</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">ordered</span><span class="o">,</span>
           <span class="kt">boolean</span> <span class="n">sticky</span><span class="o">,</span> <span class="kt">int</span> <span class="n">sendingUser</span><span class="o">,</span> <span class="kt">int</span> <span class="n">processState</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RemoteException</span> <span class="o">{</span>
       <span class="n">updateProcessState</span><span class="o">(</span><span class="n">processState</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
       <span class="n">receiver</span><span class="o">.</span><span class="na">performReceive</span><span class="o">(</span><span class="n">intent</span><span class="o">,</span> <span class="n">resultCode</span><span class="o">,</span> <span class="n">dataStr</span><span class="o">,</span> <span class="n">extras</span><span class="o">,</span> <span class="n">ordered</span><span class="o">,</span>
               <span class="n">sticky</span><span class="o">,</span> <span class="n">sendingUser</span><span class="o">);</span>
   <span class="o">}</span>
</code></pre></div><p>上面的<code>receiver.performReceive()</code>中的<code>receiver</code>对应着<code>IIntentReceiver</code>类型的接口. 而具体的实现就是<code>ReceiverDispatcher$InnerReceiver</code>. 这两个嵌套的内部类是所属在<code>LoadedApk</code>中的.  好了看一下<code>performReceiver()</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">performReceive</span><span class="o">(</span><span class="n">Intent</span> <span class="n">intent</span><span class="o">,</span> <span class="kt">int</span> <span class="n">resultCode</span><span class="o">,</span> <span class="n">String</span> <span class="n">data</span><span class="o">,</span>
                    <span class="n">Bundle</span> <span class="n">extras</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">ordered</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">sticky</span><span class="o">,</span> <span class="kt">int</span> <span class="n">sendingUser</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">LoadedApk</span><span class="o">.</span><span class="na">ReceiverDispatcher</span> <span class="n">rd</span> <span class="o">=</span> <span class="n">mDispatcher</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">ActivityThread</span><span class="o">.</span><span class="na">DEBUG_BROADCAST</span><span class="o">)</span> <span class="o">{</span>
                    <span class="kt">int</span> <span class="n">seq</span> <span class="o">=</span> <span class="n">intent</span><span class="o">.</span><span class="na">getIntExtra</span><span class="o">(</span><span class="s">&#34;seq&#34;</span><span class="o">,</span> <span class="o">-</span><span class="n">1</span><span class="o">);</span>
                    <span class="n">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">ActivityThread</span><span class="o">.</span><span class="na">TAG</span><span class="o">,</span> <span class="s">&#34;Receiving broadcast &#34;</span> <span class="o">+</span> <span class="n">intent</span><span class="o">.</span><span class="na">getAction</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34; seq=&#34;</span> <span class="o">+</span> <span class="n">seq</span>
                            <span class="o">+</span> <span class="s">&#34; to &#34;</span> <span class="o">+</span> <span class="o">(</span><span class="n">rd</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">rd</span><span class="o">.</span><span class="na">mReceiver</span> <span class="o">:</span> <span class="kc">null</span><span class="o">));</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">rd</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">rd</span><span class="o">.</span><span class="na">performReceive</span><span class="o">(</span><span class="n">intent</span><span class="o">,</span> <span class="n">resultCode</span><span class="o">,</span> <span class="n">data</span><span class="o">,</span> <span class="n">extras</span><span class="o">,</span>
                            <span class="n">ordered</span><span class="o">,</span> <span class="n">sticky</span><span class="o">,</span> <span class="n">sendingUser</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="c1">// The activity manager dispatched a broadcast to a registered
</span><span class="c1"></span>                    <span class="c1">// receiver in this process, but before it could be delivered the
</span><span class="c1"></span>                    <span class="c1">// receiver was unregistered.  Acknowledge the broadcast on its
</span><span class="c1"></span>                    <span class="c1">// behalf so that the system&#39;s broadcast sequence can continue.
</span><span class="c1"></span>                    <span class="k">if</span> <span class="o">(</span><span class="n">ActivityThread</span><span class="o">.</span><span class="na">DEBUG_BROADCAST</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">ActivityThread</span><span class="o">.</span><span class="na">TAG</span><span class="o">,</span>
                            <span class="s">&#34;Finishing broadcast to unregistered receiver&#34;</span><span class="o">);</span>
                    <span class="n">IActivityManager</span> <span class="n">mgr</span> <span class="o">=</span> <span class="n">ActivityManagerNative</span><span class="o">.</span><span class="na">getDefault</span><span class="o">();</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">extras</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">extras</span><span class="o">.</span><span class="na">setAllowFds</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
                        <span class="o">}</span>
                        <span class="n">mgr</span><span class="o">.</span><span class="na">finishReceiver</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">resultCode</span><span class="o">,</span> <span class="n">data</span><span class="o">,</span> <span class="n">extras</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">intent</span><span class="o">.</span><span class="na">getFlags</span><span class="o">());</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">ActivityThread</span><span class="o">.</span><span class="na">TAG</span><span class="o">,</span> <span class="s">&#34;Couldn&#39;t finish broadcast to unregistered receiver&#34;</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>上面又调用了<code>LoadedApk$ReceiverDispatcher#performReceive()</code>的方法.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">performReceive</span><span class="o">(</span><span class="n">Intent</span> <span class="n">intent</span><span class="o">,</span> <span class="kt">int</span> <span class="n">resultCode</span><span class="o">,</span> <span class="n">String</span> <span class="n">data</span><span class="o">,</span>
                <span class="n">Bundle</span> <span class="n">extras</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">ordered</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">sticky</span><span class="o">,</span> <span class="kt">int</span> <span class="n">sendingUser</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">ActivityThread</span><span class="o">.</span><span class="na">DEBUG_BROADCAST</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">seq</span> <span class="o">=</span> <span class="n">intent</span><span class="o">.</span><span class="na">getIntExtra</span><span class="o">(</span><span class="s">&#34;seq&#34;</span><span class="o">,</span> <span class="o">-</span><span class="n">1</span><span class="o">);</span>
                <span class="n">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">ActivityThread</span><span class="o">.</span><span class="na">TAG</span><span class="o">,</span> <span class="s">&#34;Enqueueing broadcast &#34;</span> <span class="o">+</span> <span class="n">intent</span><span class="o">.</span><span class="na">getAction</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34; seq=&#34;</span> <span class="o">+</span> <span class="n">seq</span>
                        <span class="o">+</span> <span class="s">&#34; to &#34;</span> <span class="o">+</span> <span class="n">mReceiver</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">Args</span> <span class="n">args</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Args</span><span class="o">(</span><span class="n">intent</span><span class="o">,</span> <span class="n">resultCode</span><span class="o">,</span> <span class="n">data</span><span class="o">,</span> <span class="n">extras</span><span class="o">,</span> <span class="n">ordered</span><span class="o">,</span>
                    <span class="n">sticky</span><span class="o">,</span> <span class="n">sendingUser</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">mActivityThread</span><span class="o">.</span><span class="na">post</span><span class="o">(</span><span class="n">args</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">mRegistered</span> <span class="o">&amp;&amp;</span> <span class="n">ordered</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">IActivityManager</span> <span class="n">mgr</span> <span class="o">=</span> <span class="n">ActivityManagerNative</span><span class="o">.</span><span class="na">getDefault</span><span class="o">();</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">ActivityThread</span><span class="o">.</span><span class="na">DEBUG_BROADCAST</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">ActivityThread</span><span class="o">.</span><span class="na">TAG</span><span class="o">,</span>
                            <span class="s">&#34;Finishing sync broadcast to &#34;</span> <span class="o">+</span> <span class="n">mReceiver</span><span class="o">);</span>
                    <span class="n">args</span><span class="o">.</span><span class="na">sendFinished</span><span class="o">(</span><span class="n">mgr</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
</code></pre></div><p>在<code>performReceiver()</code>这个方法中, 会创建一个<code>Args</code>对象并通过<code>mActivityThread</code>的<strong>post</strong>方法执行<code>args</code>中的逻辑.  而这些类的本质关系就是:</p>
<ul>
<li>Args: 实现类Runnable</li>
<li>mActivityThread: 是一个Handler, 就是<code>ActivityThread</code>中的mH. mH就是<code>ActivityThread$H</code>. 这个内部类H以前说过.</li>
</ul>
<p>而实现Runnable接口的<code>Args</code>中有如下代码:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">ClassLoader</span> <span class="n">cl</span> <span class="o">=</span>  <span class="n">mReceiver</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getClassLoader</span><span class="o">();</span>
<span class="n">intent</span><span class="o">.</span><span class="na">setExtrasClassLoader</span><span class="o">(</span><span class="n">cl</span><span class="o">);</span>
<span class="n">setExtrasClassLoader</span><span class="o">(</span><span class="n">cl</span><span class="o">);</span>
<span class="n">receiver</span><span class="o">.</span><span class="na">setPendingResult</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
<span class="n">receiver</span><span class="o">.</span><span class="na">onReceive</span><span class="o">(</span><span class="n">mContext</span><span class="o">,</span> <span class="n">intent</span><span class="o">);</span>
</code></pre></div><p>这个时候<code>BroadcastReceiver#onReceive()</code>方法被执行了, 也就是说应用已经接收到了广播, 同时<code>onReceive()</code>方法是在广播接收者的主线程中被调用的.</p>
<h2 id="contentprovider的工作机制">ContentProvider的工作机制</h2>
<p><code>ContentProvider</code>是一种内容共享型组件, 它通过<code>Binder</code>向其他组件乃至其他应用提供数据. 当<code>ContentProvider</code>所在的进程启动时, <code>ContentProvider</code>会同时启动并发布到AMS中. 要注意:<strong>这个时候ContentProvider的onCreate()方法是先于Application的onCreate()执行的</strong>这一点在四大组件是少有的现象.</p>
<p>当一个应用启动的时候, 入口的方法为<code>ActivityThread#main()</code>方法, main方法为一个静态方法, 在main方法中会创建<code>ActivityThread</code>的实例, 并创建主线程的消息队列, 然后在<code>ActivityThread#attach()</code>方法中会远程调用<code>AMS#attachApplication()</code>并将<code>ApplicationThread</code>对象提供给AMS.</p>
<p><code>ApplicationThread</code>是一个<code>Binder</code>对象, 它的Binder接口是<code>IApplicationThread</code>, 主要用于<code>ActivityThread</code>和<code>AMS</code>之间的通信, 这一点在前面多次提到. 在<code>AMS</code>的<code>attachApplication()</code>中, 会调用<code>ApplicationThread#bindApplication()</code>. 这个过程同样是跨进程的. <code>bindApplication()</code>中会经过 <code>ActivityThread</code>中的mh(Handler) 切换到<code>ActivityThread</code>中去执行, 具体的方式是<code>handleBindApplication()</code>.</p>
<p>在<code>handleBindApplication()</code>方法中, <code>ActivityThread</code>会创建<code>Application</code>对象并加载<code>ContentProvider</code>. 需要注意的是, <code>ActivityThread</code>会先加载<code>ContentProvider</code>, 然后在调用<code>Application#onCreate()</code>方法</p>
<hr>
<p>以上就是<code>ContentProvider</code>的启动过程, <code>ContentProvider</code>启动后, 外界就可以通过它所提供的增删改查这四个接口来操作<code>ContentProvider</code>中的数据源, 这四个方法都是通过Binder来调用的, 外界无法直接访问<code>ContentProvider</code>, 它只能通过<code>AMS</code>根据<code>URI</code>来获取到对应的<code>ContentProvider</code>的<code>Binder</code>接口<code>IContentProvider</code>, 然后再通过<code>IContentProvider</code>来访问<code>ContentProvider</code>中的数据源.</p>
<p><strong>ContentProvider是否属于单实例?</strong></p>
<p>具体<code>ContentProvider</code>是否是单实例取决于<code>android:multiprocess</code>属性来决定的, 当其值为<strong>false</strong>的时候, 就是单实例也是默认值. 如果为<strong>true</strong>那就为多实例. 这个时候在每一个调用者的进程中都会存在一个<code>ContentProvider</code>对象.</p>
<hr>
<p><strong>通过单实例的ContentProvider来分析一下启动过程</strong></p>
<p>首先访问<code>ContentProvider</code>需要通过<code>ContentResolver</code>, <code>ContentResolver</code>是一个抽象类, 通过<code>Content#getContentResolver()</code>方法获取的实际上是<code>ApplicationContentResolver</code>对象, 而这个类继承了<code>ContentProvider</code>并实现了其抽象方法. 当<code>ContentProvider</code>所在的进程未启动时, 第一次访问它的时候就会触发<code>ContentProvider</code>的创建, 当然这也伴随着<code>ContentProvider</code>所在的进程的启动. 通过四个对数据的操作方法中的任何一个, 都可以触发<code>ContentProvider</code>的启动过程.</p>
<p><strong>四种操作过程差不多, 那么这里以query方法为例</strong></p>
<p>首先会获取<code>IContentProvider</code>对象, 不管是通过<code>acquireUnstableProvider()</code>方法还是直接通过<code>acquireProvider()</code>方法, 他们的本质都是一样的, 最终都是通过<code>acquireProvider</code>方法来获取ContentProvider.</p>
<p><code>ApplicationContentResolver#acquireProvider()</code>方法并没有处理任何逻辑, 它直接调用了<code>ActivityThread#acquireProvider()</code>, 这个方法如下:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">final</span> <span class="n">IContentProvider</span> <span class="nf">acquireProvider</span><span class="o">(</span>
            <span class="n">Context</span> <span class="n">c</span><span class="o">,</span> <span class="n">String</span> <span class="n">auth</span><span class="o">,</span> <span class="kt">int</span> <span class="n">userId</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">stable</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">IContentProvider</span> <span class="n">provider</span> <span class="o">=</span> <span class="n">acquireExistingProvider</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="n">auth</span><span class="o">,</span> <span class="n">userId</span><span class="o">,</span> <span class="n">stable</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">provider</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">provider</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="n">IActivityManager</span><span class="o">.</span><span class="na">ContentProviderHolder</span> <span class="n">holder</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">holder</span> <span class="o">=</span> <span class="n">ActivityManagerNative</span><span class="o">.</span><span class="na">getDefault</span><span class="o">().</span><span class="na">getContentProvider</span><span class="o">(</span>
                    <span class="n">getApplicationThread</span><span class="o">(),</span> <span class="n">auth</span><span class="o">,</span> <span class="n">userId</span><span class="o">,</span> <span class="n">stable</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">holder</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Slog</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Failed to find provider info for &#34;</span> <span class="o">+</span> <span class="n">auth</span><span class="o">);</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">// Install provider will increment the reference count for us, and break
</span><span class="c1"></span>        <span class="c1">// any ties in the race.
</span><span class="c1"></span>        <span class="n">holder</span> <span class="o">=</span> <span class="n">installProvider</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="n">holder</span><span class="o">,</span> <span class="n">holder</span><span class="o">.</span><span class="na">info</span><span class="o">,</span>
                <span class="kc">true</span> <span class="cm">/*noisy*/</span><span class="o">,</span> <span class="n">holder</span><span class="o">.</span><span class="na">noReleaseNeeded</span><span class="o">,</span> <span class="n">stable</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">holder</span><span class="o">.</span><span class="na">provider</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><p>这段代码主要从<code>ActivityThread</code>中查找是否已经存在了<code>ContentProvider</code>了, 如果存在那么就直接返回. <code>ActivityThread</code>中通过<code>mProviderMap</code>来存储已经启动的<code>ContentProvider</code>对象, 这个集合的存储类型<code>ArrayMap&lt;ProviderKey, ProviderClientRecord&gt; mProviderMap</code>. 如果目前<code>ContentProvider</code>没有启动, 那么就发送一个进程间请求给<code>AMS</code>让其启动项目目标<code>ContentProvider</code>, 最后再通过<code>installProvider()</code>方法来修改引用计数.</p>
<p>那么AMS是如何启动<code>ContentProvider</code>的呢?</p>
<p>关于<code>ContentProvider</code>被启动的时候会伴随着进程的启动, 在<code>AMS</code>中, 首先会启动<code>ContentProvider</code>所在的进程, 然后再启动<code>ContentProvider</code>. 启动进程是由<code>AMS#startProcessLocked()</code>方法来完成, 其内部主要是通过<code>Process#start()</code>方法来完成一个新进程的启动, 新进程启动后其入口方法为<code>ActivityThread#main()</code>方法. 如下:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Trace</span><span class="o">.</span><span class="na">traceBegin</span><span class="o">(</span><span class="n">Trace</span><span class="o">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="o">,</span> <span class="s">&#34;ActivityThreadMain&#34;</span><span class="o">);</span>
        <span class="n">SamplingProfilerIntegration</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

        <span class="c1">// CloseGuard defaults to true and can be quite spammy.  We
</span><span class="c1"></span>        <span class="c1">// disable it here, but selectively enable it later (via
</span><span class="c1"></span>        <span class="c1">// StrictMode) on debug builds, but using DropBox, not logs.
</span><span class="c1"></span>        <span class="n">CloseGuard</span><span class="o">.</span><span class="na">setEnabled</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>

        <span class="n">Environment</span><span class="o">.</span><span class="na">initForCurrentUser</span><span class="o">();</span>

        <span class="c1">// Set the reporter for event logging in libcore
</span><span class="c1"></span>        <span class="n">EventLogger</span><span class="o">.</span><span class="na">setReporter</span><span class="o">(</span><span class="k">new</span> <span class="n">EventLoggingReporter</span><span class="o">());</span>

        <span class="n">AndroidKeyStoreProvider</span><span class="o">.</span><span class="na">install</span><span class="o">();</span>

        <span class="c1">// Make sure TrustedCertificateStore looks in the right place for CA certificates
</span><span class="c1"></span>        <span class="kd">final</span> <span class="n">File</span> <span class="n">configDir</span> <span class="o">=</span> <span class="n">Environment</span><span class="o">.</span><span class="na">getUserConfigDirectory</span><span class="o">(</span><span class="n">UserHandle</span><span class="o">.</span><span class="na">myUserId</span><span class="o">());</span>
        <span class="n">TrustedCertificateStore</span><span class="o">.</span><span class="na">setDefaultUserDirectory</span><span class="o">(</span><span class="n">configDir</span><span class="o">);</span>

        <span class="n">Process</span><span class="o">.</span><span class="na">setArgV0</span><span class="o">(</span><span class="s">&#34;&lt;pre-initialized&gt;&#34;</span><span class="o">);</span>

        <span class="n">Looper</span><span class="o">.</span><span class="na">prepareMainLooper</span><span class="o">();</span>

        <span class="n">ActivityThread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ActivityThread</span><span class="o">();</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">attach</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">sMainThreadHandler</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">sMainThreadHandler</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="na">getHandler</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="kc">false</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Looper</span><span class="o">.</span><span class="na">myLooper</span><span class="o">().</span><span class="na">setMessageLogging</span><span class="o">(</span><span class="k">new</span>
                    <span class="n">LogPrinter</span><span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">DEBUG</span><span class="o">,</span> <span class="s">&#34;ActivityThread&#34;</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="c1">// End of event ActivityThreadMain.
</span><span class="c1"></span>        <span class="n">Trace</span><span class="o">.</span><span class="na">traceEnd</span><span class="o">(</span><span class="n">Trace</span><span class="o">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="o">);</span>
        <span class="n">Looper</span><span class="o">.</span><span class="na">loop</span><span class="o">();</span>

        <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="s">&#34;Main thread loop unexpectedly exited&#34;</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><p><code>ActivityThread#main()</code>是一个静态方法, 在它的内部首先会创建<code>ActivityThread</code>实例并调用<code>attach()</code>方法来进行一系列初始化, 接着就开始进行消息循环. <code>ActivityThread#attach()</code>方法会将<code>Application</code>对象通过<code>AMS#attachApplication</code>方法跨进程传递给AMS, 最终AMS会完成<code>ContentProvider</code>的创建过程.</p>
<p><code>ActivityThread#attach()</code>部分代码:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="k">try</span> <span class="o">{</span>
      <span class="n">mgr</span><span class="o">.</span><span class="na">attachApplication</span><span class="o">(</span><span class="n">mAppThread</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// Ignore
</span><span class="c1"></span>  <span class="o">}</span>
</code></pre></div><p><code>AMS#attachApplication()</code>方法调用了<code>attachApplication()</code>, 然后又调用了<code>ApplicationThread#bindApplication()</code>,  这个过程也属于进程通信.</p>
<p>而上面的<code>bindApplication()</code>方法会发送一个<code>BIND_APPLICATION</code>类型的消息给<code>mH</code>, 这是一个Handler, 它收到消息后会调用<code>ActivityThread#handleBindApplication()</code>方法. <code>bindApplication()</code>发送源码如下:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java">  <span class="n">AppBindData</span> <span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AppBindData</span><span class="o">();</span>
  <span class="n">data</span><span class="o">.</span><span class="na">processName</span> <span class="o">=</span> <span class="n">processName</span><span class="o">;</span>
  <span class="n">data</span><span class="o">.</span><span class="na">appInfo</span> <span class="o">=</span> <span class="n">appInfo</span><span class="o">;</span>
  <span class="n">data</span><span class="o">.</span><span class="na">providers</span> <span class="o">=</span> <span class="n">providers</span><span class="o">;</span>
  <span class="n">data</span><span class="o">.</span><span class="na">instrumentationName</span> <span class="o">=</span> <span class="n">instrumentationName</span><span class="o">;</span>
  <span class="n">data</span><span class="o">.</span><span class="na">instrumentationArgs</span> <span class="o">=</span> <span class="n">instrumentationArgs</span><span class="o">;</span>
  <span class="n">data</span><span class="o">.</span><span class="na">instrumentationWatcher</span> <span class="o">=</span> <span class="n">instrumentationWatcher</span><span class="o">;</span>
  <span class="n">data</span><span class="o">.</span><span class="na">instrumentationUiAutomationConnection</span> <span class="o">=</span> <span class="n">instrumentationUiConnection</span><span class="o">;</span>
  <span class="n">data</span><span class="o">.</span><span class="na">debugMode</span> <span class="o">=</span> <span class="n">debugMode</span><span class="o">;</span>
  <span class="n">data</span><span class="o">.</span><span class="na">enableOpenGlTrace</span> <span class="o">=</span> <span class="n">enableOpenGlTrace</span><span class="o">;</span>
  <span class="n">data</span><span class="o">.</span><span class="na">restrictedBackupMode</span> <span class="o">=</span> <span class="n">isRestrictedBackupMode</span><span class="o">;</span>
  <span class="n">data</span><span class="o">.</span><span class="na">persistent</span> <span class="o">=</span> <span class="n">persistent</span><span class="o">;</span>
  <span class="n">data</span><span class="o">.</span><span class="na">config</span> <span class="o">=</span> <span class="n">config</span><span class="o">;</span>
  <span class="n">data</span><span class="o">.</span><span class="na">compatInfo</span> <span class="o">=</span> <span class="n">compatInfo</span><span class="o">;</span>
  <span class="n">data</span><span class="o">.</span><span class="na">initProfilerInfo</span> <span class="o">=</span> <span class="n">profilerInfo</span><span class="o">;</span>
  <span class="n">sendMessage</span><span class="o">(</span><span class="n">H</span><span class="o">.</span><span class="na">BIND_APPLICATION</span><span class="o">,</span> <span class="n">data</span><span class="o">);</span>
</code></pre></div><p><code>ActivityThread#handlerBindApplication()</code>则完成了Application的创建以及<code>ContentProvider</code> 可以分为如下四个步骤:</p>
<ol>
<li>创建<code>ContentProvider</code>和<code>Instrumentation</code></li>
<li>创建<code>Application</code>对象</li>
<li>启动当前进程的<code>ContentProvider</code>并调用onCreate()方法. 主要内部实现是<code>installContentProvider()</code>完成了<code>ContentProvider</code>的启动工作, 首先会遍历当前进程的<code>ProviderInfo</code>的列表并一一调用<code>installProvider()</code>方法来启动他们, 接着将已经启动的<code>ContentProvider</code>发布到AMS中, AMS会把他们存储在<code>ProviderMap</code>中, 这样一来外部调用者就可以直接从AMS中获取到<code>ContentProvider</code>.    **installProvider()**内部通过类加载器创建的<code>ContentProvider</code>实例并在方法中调用了<code>attachInfo()</code>, 在这内部调用了<code>ContentProvider#onCreate()</code></li>
<li>调用<code>Application#onCreate()</code></li>
</ol>
<p>经过了上述的四个步骤, <code>ContentProvider</code>已经启动成功, 并且其所在的进程的<code>Application</code>也已经成功, 这意味着<code>ContentProvider</code>所在的进程已经完成了整个的启动过程, 然后其他应用就可以通过<code>AMS</code>来访问这个<code>ContentProvider</code>了.</p>
<p>当拿到了<code>ContentProvider</code>以后, 就可以通过它所提供的接口方法来访问它. 这里要注意: <strong>这里的ContentProvider并不是原始的<code>ContentProvider</code></strong>. 而是<code>ContentProvider</code>的Binder类型对象<code>IContentProvider</code>,  而<code>IContentProvider</code>的具体实现是<code>ContentProviderNative</code>和<code>ContentProvider.Transport</code>.  后者继承了前者.</p>
<p>如果还用query方法来解释流程: 那么最开始其他应用通过<code>AMS</code>获取到<code>ContentProvider</code>的<code>Binder</code>对象就是<code>IContentProvider</code>. 而<code>IContentProvider</code>的实际实现者是<code>ContentProvider.Transport</code>. 因此实际上外部应用调用的时候本质上<strong>会以进程间通信的方式调用ContentProvider.Transport的query()方法</strong></p>
<blockquote>
<p>下一章: 第10章 Android的消息机制</p>
</blockquote>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2016-08-16</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="http://suzeyu.com/posts/android-%E5%BC%80%E5%8F%91%E8%89%BA%E6%9C%AF%E6%8E%A2%E7%B4%A2-09-%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%9A%84%E5%B7%A5%E4%BD%9C%E8%BF%87%E7%A8%8B/" data-title="《Android 开发艺术探索》 09-四大组件的工作过程" data-via="xxxx" data-hashtags="android,笔记"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="http://suzeyu.com/posts/android-%E5%BC%80%E5%8F%91%E8%89%BA%E6%9C%AF%E6%8E%A2%E7%B4%A2-09-%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%9A%84%E5%B7%A5%E4%BD%9C%E8%BF%87%E7%A8%8B/" data-hashtag="android"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="分享到 WhatsApp" data-sharer="whatsapp" data-url="http://suzeyu.com/posts/android-%E5%BC%80%E5%8F%91%E8%89%BA%E6%9C%AF%E6%8E%A2%E7%B4%A2-09-%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%9A%84%E5%B7%A5%E4%BD%9C%E8%BF%87%E7%A8%8B/" data-title="《Android 开发艺术探索》 09-四大组件的工作过程" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="http://suzeyu.com/posts/android-%E5%BC%80%E5%8F%91%E8%89%BA%E6%9C%AF%E6%8E%A2%E7%B4%A2-09-%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%9A%84%E5%B7%A5%E4%BD%9C%E8%BF%87%E7%A8%8B/" data-title="《Android 开发艺术探索》 09-四大组件的工作过程"><i data-svg-src="/lib/simple-icons/icons/line.min.svg"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="http://suzeyu.com/posts/android-%E5%BC%80%E5%8F%91%E8%89%BA%E6%9C%AF%E6%8E%A2%E7%B4%A2-09-%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%9A%84%E5%B7%A5%E4%BD%9C%E8%BF%87%E7%A8%8B/" data-title="《Android 开发艺术探索》 09-四大组件的工作过程" data-ralateuid="611267109"><i class="fab fa-weibo fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Myspace" data-sharer="myspace" data-url="http://suzeyu.com/posts/android-%E5%BC%80%E5%8F%91%E8%89%BA%E6%9C%AF%E6%8E%A2%E7%B4%A2-09-%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%9A%84%E5%B7%A5%E4%BD%9C%E8%BF%87%E7%A8%8B/" data-title="《Android 开发艺术探索》 09-四大组件的工作过程" data-description=""><i data-svg-src="/lib/simple-icons/icons/myspace.min.svg"></i></a><a href="javascript:void(0);" title="分享到 Blogger" data-sharer="blogger" data-url="http://suzeyu.com/posts/android-%E5%BC%80%E5%8F%91%E8%89%BA%E6%9C%AF%E6%8E%A2%E7%B4%A2-09-%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%9A%84%E5%B7%A5%E4%BD%9C%E8%BF%87%E7%A8%8B/" data-title="《Android 开发艺术探索》 09-四大组件的工作过程" data-description=""><i class="fab fa-blogger fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Evernote" data-sharer="evernote" data-url="http://suzeyu.com/posts/android-%E5%BC%80%E5%8F%91%E8%89%BA%E6%9C%AF%E6%8E%A2%E7%B4%A2-09-%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%9A%84%E5%B7%A5%E4%BD%9C%E8%BF%87%E7%A8%8B/" data-title="《Android 开发艺术探索》 09-四大组件的工作过程"><i class="fab fa-evernote fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/android/">android</a>,&nbsp;<a href="/tags/%E7%AC%94%E8%AE%B0/">笔记</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/android-%E5%BC%80%E5%8F%91%E8%89%BA%E6%9C%AF%E6%8E%A2%E7%B4%A2-08-%E7%90%86%E8%A7%A3window%E5%92%8Cwindowmanager/" class="prev" rel="prev" title="《Android 开发艺术探索》 08-理解Window和WindowManager"><i class="fas fa-angle-left fa-fw"></i>《Android 开发艺术探索》 08-理解Window和WindowManager</a>
            <a href="/posts/android-%E5%BC%80%E5%8F%91%E8%89%BA%E6%9C%AF%E6%8E%A2%E7%B4%A2-10-android%E7%9A%84%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6/" class="next" rel="next" title="《Android 开发艺术探索》 10-Android的消息机制">《Android 开发艺术探索》 10-Android的消息机制<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="valine" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://valine.js.org/">Valine</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.92.2">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                    <span id="busuanzi_container_site_pv">
    本站访问量：<span id="busuanzi_value_site_pv"></span>次
</span>


                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2016 - 2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">su</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/valine/valine.min.css"><script type="text/javascript" src="/lib/valine/Valine.min.js"></script><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/algoliasearch/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{"valine":{"appId":"PaWjmRBsSAVP4ttqFgysPCeb-MdYXbMMI","appKey":"F7VwMCWDDzUmWeVjApOCvaAs","avatar":"mp","el":"#valine","emojiCDN":"https://cdn.jsdelivr.net/npm/emoji-datasource-google@5.0.1/img/google/64/","emojiMaps":{"100":"1f4af.png","alien":"1f47d.png","anger":"1f4a2.png","angry":"1f620.png","anguished":"1f627.png","astonished":"1f632.png","black_heart":"1f5a4.png","blue_heart":"1f499.png","blush":"1f60a.png","bomb":"1f4a3.png","boom":"1f4a5.png","broken_heart":"1f494.png","brown_heart":"1f90e.png","clown_face":"1f921.png","cold_face":"1f976.png","cold_sweat":"1f630.png","confounded":"1f616.png","confused":"1f615.png","cry":"1f622.png","crying_cat_face":"1f63f.png","cupid":"1f498.png","dash":"1f4a8.png","disappointed":"1f61e.png","disappointed_relieved":"1f625.png","dizzy":"1f4ab.png","dizzy_face":"1f635.png","drooling_face":"1f924.png","exploding_head":"1f92f.png","expressionless":"1f611.png","face_vomiting":"1f92e.png","face_with_cowboy_hat":"1f920.png","face_with_hand_over_mouth":"1f92d.png","face_with_head_bandage":"1f915.png","face_with_monocle":"1f9d0.png","face_with_raised_eyebrow":"1f928.png","face_with_rolling_eyes":"1f644.png","face_with_symbols_on_mouth":"1f92c.png","face_with_thermometer":"1f912.png","fearful":"1f628.png","flushed":"1f633.png","frowning":"1f626.png","ghost":"1f47b.png","gift_heart":"1f49d.png","green_heart":"1f49a.png","grimacing":"1f62c.png","grin":"1f601.png","grinning":"1f600.png","hankey":"1f4a9.png","hear_no_evil":"1f649.png","heart":"2764-fe0f.png","heart_decoration":"1f49f.png","heart_eyes":"1f60d.png","heart_eyes_cat":"1f63b.png","heartbeat":"1f493.png","heartpulse":"1f497.png","heavy_heart_exclamation_mark_ornament":"2763-fe0f.png","hole":"1f573-fe0f.png","hot_face":"1f975.png","hugging_face":"1f917.png","hushed":"1f62f.png","imp":"1f47f.png","innocent":"1f607.png","japanese_goblin":"1f47a.png","japanese_ogre":"1f479.png","joy":"1f602.png","joy_cat":"1f639.png","kiss":"1f48b.png","kissing":"1f617.png","kissing_cat":"1f63d.png","kissing_closed_eyes":"1f61a.png","kissing_heart":"1f618.png","kissing_smiling_eyes":"1f619.png","laughing":"1f606.png","left_speech_bubble":"1f5e8-fe0f.png","love_letter":"1f48c.png","lying_face":"1f925.png","mask":"1f637.png","money_mouth_face":"1f911.png","nauseated_face":"1f922.png","nerd_face":"1f913.png","neutral_face":"1f610.png","no_mouth":"1f636.png","open_mouth":"1f62e.png","orange_heart":"1f9e1.png","partying_face":"1f973.png","pensive":"1f614.png","persevere":"1f623.png","pleading_face":"1f97a.png","pouting_cat":"1f63e.png","purple_heart":"1f49c.png","rage":"1f621.png","relaxed":"263a-fe0f.png","relieved":"1f60c.png","revolving_hearts":"1f49e.png","right_anger_bubble":"1f5ef-fe0f.png","robot_face":"1f916.png","rolling_on_the_floor_laughing":"1f923.png","scream":"1f631.png","scream_cat":"1f640.png","see_no_evil":"1f648.png","shushing_face":"1f92b.png","skull":"1f480.png","skull_and_crossbones":"2620-fe0f.png","sleeping":"1f634.png","sleepy":"1f62a.png","slightly_frowning_face":"1f641.png","slightly_smiling_face":"1f642.png","smile":"1f604.png","smile_cat":"1f638.png","smiley":"1f603.png","smiley_cat":"1f63a.png","smiling_face_with_3_hearts":"1f970.png","smiling_imp":"1f608.png","smirk":"1f60f.png","smirk_cat":"1f63c.png","sneezing_face":"1f927.png","sob":"1f62d.png","space_invader":"1f47e.png","sparkling_heart":"1f496.png","speak_no_evil":"1f64a.png","speech_balloon":"1f4ac.png","star-struck":"1f929.png","stuck_out_tongue":"1f61b.png","stuck_out_tongue_closed_eyes":"1f61d.png","stuck_out_tongue_winking_eye":"1f61c.png","sunglasses":"1f60e.png","sweat":"1f613.png","sweat_drops":"1f4a6.png","sweat_smile":"1f605.png","thinking_face":"1f914.png","thought_balloon":"1f4ad.png","tired_face":"1f62b.png","triumph":"1f624.png","two_hearts":"1f495.png","unamused":"1f612.png","upside_down_face":"1f643.png","weary":"1f629.png","white_frowning_face":"2639-fe0f.png","white_heart":"1f90d.png","wink":"1f609.png","woozy_face":"1f974.png","worried":"1f61f.png","yawning_face":"1f971.png","yellow_heart":"1f49b.png","yum":"1f60b.png","zany_face":"1f92a.png","zipper_mouth_face":"1f910.png","zzz":"1f4a4.png"},"enableQQ":false,"highlight":true,"lang":"zh-cn","pageSize":10,"placeholder":"有什么好的建议嘛??","recordIP":true,"visitor":true}},"search":{"algoliaAppID":"QJB5WVGU23","algoliaIndex":"suzeyu","algoliaSearchKey":"717d6b0889638f7562bef472bd100d44","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
